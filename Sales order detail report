Select
  ROWNUM SR_NO,
  SOD.BU_NAME,
  SOD.DIVISION,
  SOD.ACCOUNT_NUMBER,
  SOD.PARTY_NAME,
  SOD.CONTACT_NAME,
  SOD.CONTACT_MAIL,
  SOD.CONTACT_PHONE,
  SOD.CUST_REG_NUMBER,
  --LEAD_OPP_V.L_SALES_ENGINEER,
  SOD.L_SALES_ENGINEER,
  SOD.LEAD_NUMBER,
  SOD.LEAD_NAME,
  SOD.L_PREPARER,
  SOD.LEAD_CREATION_DATE,
  SOD.L_APPRD_DT,
  SOD.L_APPR_STS,
  SOD.OPTY_NUMBER,
  SOD.OPTY_CREATION_DATE,
  SOD.APPD_QUT_NO,
  SOD.APPD_QUT_DT,
  SOD.L_JOB_REF_NO,
  SOD.PROFIT_CENTER,
  SOD.SO_AGR_NO,
  SOD.SO_AGR_LIN_NO,
  SOD.SO_NO,
  SOD.SO_CRE_DT,
  SOD.SO_REL_DT,
  SOD.SO_ORD_TYP,
  SOD.SO_STATUS,
  SOD.SE_EMP_NO,
  SOD.SE_EMP_NAME,
  SOD.SO_LINE_NO,
  SOD.SO_LINE_TYPE,
  SOD.CATEGORY_CODE,
  SOD.CATEGORY_DESC,
  SOD.ITEM_CODE,
  SOD.ITEM_DESC,
  SOD.UNIT_OF_MEASURE,
  SOD.ORDERED_QTY,
  SOD.SO_CURRENCY_CODE,
  SOD.SO_LINE_UNIT_PRICE,
  SOD.SO_LINE_AMT,
  SOD.SO_EXCH_RATE,
  SOD.SO_TOT_AMT,
  SOD.DISPATCH_QTY,
  SOD.D_DISPATCH_QTY,
  SOD.RETURN_QTY,
  SOD.SO_REMAIN_QTY SO_REMAIN_QTY,
  SOD.BILLED_QTY,
  SOD.SO_LINE_STATUS,
  SOD.DELIVERY_TERMS,
  SOD.DELIV_ORD_NUM,
  SOD.DELIV_DATE,
  SOD.DELIV_PRP_NAME,
  SOD.PO_NUM,
  SOD.VENDOR_NUM,
  SOD.VENDOR_NAME,
  SOD.ICV_VALUE,
  SOD.ICV_VALUE_AED,
  SOD.INVOICE_TYPE,
  SOD.INV_NUM,
  SOD.INV_DATE,
  SOD.INV_DOC_SEQ_VAL,
  SOD.INV_E_CURR,
  SOD.SALES_AMT,
  SOD.TAX_RATE_CODE,
  SOD.TAX_AMT,
  SOD.SALES_TOT_AMT,
  SOD.I_EXCH_RATE,
  SOD.SALES_AMOUNT_AED,
  SOD.TAX_AMT_AED,
  SOD.SALES_TOT_AMT_AED,
  SOD.INV_TERMS,
  SOD.INV_TERM_DESC,
  SOD.INV_CRE_BY,
  SOD.RECEIPT_DATE,
  SOD.RECEIPT_TYPE,
  SOD.RECEIPT_NUMBER,
  SOD.R_VCH_NO,
  SOD.R_CURRENCY_CODE,
  SOD.R_AMT,
  SOD.R_EXCH_RATE,
  SOD.R_AMT_AED,
  SOD.ORD_HOLD_FLG,
  SOD.ORD_HOLD_DATE,
  SOD.ORD_HOLD_COMMENTS,
  SOD.ORD_REL_REASON,
  SOD.ORD_HOLD_REL_DATE,
  SOD.ORD_HOLD_REL_BY,
  SOD.FULFILL_LINE_ID
From
(
With  BU_V As (
Select Distinct HOU.ORGANIZATION_ID BU_ID,
				HOU.NAME BU_NAME/*,
				ZXR.TAX_REGIME_CODE TAX_REGIME*/
	From HR_OPERATING_UNITS HOU/*,
		 ZX_PARTY_TAX_PROFILE ZPTP,
		 ZX_REGIMES_USAGES ZRU,
		 ZX_REGIMES_B ZXR*/
	Where (HOU.NAME In (:P_BU_NAME) Or Least (:P_BU_NAME) Is Null)
	  /*And HOU.ORGANIZATION_ID = ZPTP.PARTY_ID
	  And ZPTP.PARTY_TAX_PROFILE_ID = ZRU.FIRST_PTY_ORG_ID
	  And ZXR.REGIME_TYPE_FLAG = 'I'
	  And Trunc(SYSDATE) Between Nvl(ZXR.EFFECTIVE_FROM,Trunc(SYSDATE)-1) And Nvl(ZXR.EFFECTIVE_TO,Trunc(SYSDATE)+1)
	  And ZXR.TAX_REGIME_CODE = ZRU.TAX_REGIME_CODE*/
	),
CUST_DTL_V AS (
Select Distinct HP.PARTY_ID,
	   HP.PARTY_NUMBER,
	   HP.PARTY_NAME,
	   HPS.PARTY_SITE_ID,
	   HPS.PARTY_SITE_NUMBER,
	   HCA.CUST_ACCOUNT_ID,
	   HCA.ACCOUNT_NUMBER,
	   HCAS.CUST_ACCT_SITE_ID,
	   --HCSU.SITE_USE_ID,
	   (Select 
	      HP_C.PERSON_FIRST_NAME||' '||HP_C.PERSON_LAST_NAME
	    From Hz_Parties HP_C
		  Where HP_C.PARTY_TYPE = 'PERSON'
		    And HP_C.PARTY_ID = HP.PREFERRED_CONTACT_PERSON_ID) CONTACT_NAME,
		(Select 
	      Distinct HCP.EMAIL_ADDRESS
		  --LISTAGG(HCP.EMAIL_ADDRESS, '/')WITHIN GROUP (ORDER BY HCP.OWNER_TABLE_ID) EMAIL_ADDRESS
	    From Hz_Contact_Points HCP
		   Where HCP.OWNER_TABLE_NAME = 'HZ_PARTIES'
		     And HCP.CONTACT_POINT_TYPE = 'EMAIL'
			 And HCP.PHONE_LINE_TYPE Is Null
			 And HCP.STATUS = 'A'
			 And HCP.PRIMARY_FLAG = 'Y'
			 And HCP.OWNER_TABLE_ID = HP.PREFERRED_CONTACT_PERSON_ID
			 And Rownum = 1) CONTACT_MAIL,
		(Select 
		  Case When HCP.RAW_PHONE_NUMBER Is Not Null Then '+'||''||HCP.RAW_PHONE_NUMBER Else HCP.RAW_PHONE_NUMBER End PH_NO
	    From Hz_Contact_Points HCP
		   Where HCP.OWNER_TABLE_NAME = 'HZ_PARTIES'
		     And HCP.CONTACT_POINT_TYPE = 'PHONE'
			 And HCP.PHONE_LINE_TYPE = 'MOBILE'
			 And HCP.STATUS = 'A'
			 And HCP.OWNER_TABLE_ID = HP.PREFERRED_CONTACT_PERSON_ID) CONTACT_PHONE,
		HP.JGZZ_FISCAL_CODE CUST_REG_NUMBER
From Hz_Parties HP,
	 Hz_Party_Sites HPS,
	 Hz_Cust_Accounts HCA,
	 Hz_Cust_Acct_Sites_All HCAS,
	 Hz_Cust_Site_Uses_All HCSU--,
	 --BU_V
Where 1=1
 And HP.PARTY_ID = HPS.PARTY_ID
 And HP.PARTY_ID = HCA.PARTY_ID
 And HPS.PARTY_SITE_ID = HCAS.PARTY_SITE_ID
 And HCA.CUST_ACCOUNT_ID = HCAS.CUST_ACCOUNT_ID
 And HCAS.CUST_ACCT_SITE_ID = HCSU.CUST_ACCT_SITE_ID
 And HCSU.PRIMARY_FLAG = 'Y'
 And HCSU.SITE_USE_CODE = 'BILL_TO'
 And Trunc(Sysdate) Between Trunc(HPS.START_DATE_ACTIVE) and Trunc(HPS.END_DATE_ACTIVE)
 And Trunc(Sysdate) Between Trunc(HCAS.START_DATE) and Trunc(HCAS.END_DATE)
 And Trunc(Sysdate) Between Trunc(HCSU.START_DATE) and Trunc(HCSU.END_DATE)
 --AND HCAS.SET_ID = FND_SETID_UTILITY.GETSETID ('HZ_CUSTOMER_ACCOUNT_SITE','BU',BU_V.BU_ID ) 
 --AND HCAS.SET_ID = FND_SETID_UTILITY.GETSETID ('HZ_CUSTOMER_ACCOUNT_SITE','BU',(SELECT Distinct BU_ID FROM BU_V) )
 And (HP.PARTY_NAME In (:P_PARTY_NAME) Or Least (:P_PARTY_NAME) Is Null)
) ,
LEAD_OPP_V AS(
Select 
	   MLL.LEAD_NUMBER,
	   MLL.LEAD_NAME,
	   MLL.CUSTOMER_ID L_PARTY_ID,
	   /*(Select 
	      PPN.DISPLAY_NAME
	    From Per_Users PU,
		     Per_Person_Names_F PPN
		  Where 1=1
		    And PU.PERSON_ID = PPN.PERSON_ID
			And PU.END_DATE Is NULL
			And PPN.NAME_TYPE = 'GLOBAL'
			And PU.USERNAME = MLL.LEAD_CREATED_BY
			And Trunc(Sysdate) Between Trunc(PPN.EFFECTIVE_START_DATE) And Trunc(PPN.EFFECTIVE_END_DATE)) L_SALES_ENGINEER,*/
	   MLL.LEAD_CREATION_DATE,
	   (Select 
	      PPN.DISPLAY_NAME
	    From Per_Users PU,
		     Per_Person_Names_F PPN
		  Where 1=1
		    And PU.PERSON_ID = PPN.PERSON_ID
			And PU.END_DATE Is NULL
			And PPN.NAME_TYPE = 'GLOBAL'
			And PU.USERNAME = MLL.CREATED_BY
			And Trunc(Sysdate) Between Trunc(PPN.EFFECTIVE_START_DATE) And Trunc(PPN.EFFECTIVE_END_DATE)) L_PREPARER,
	   MLL.APPROVAL_DATE L_APPRD_DT,
	   MLL.APPROVAL_STATUS L_APPR_STS,
	   --MLL.EXTN_ATTRIBUTE_CHAR012 L_JOB_REF_NO,
	   MLL.EXTN_ATTRIBUTE_CHAR005 L_JOB_REF_NO,
	   DIV_FLV.MEANING DIVISION,
	   MLL.BU_ID L_BU_ID,
	   MLL.CUSTOMER_ID L_CUSTOMER_ID,
	   MOP.OPTY_NUMBER,
	   MOP.OPTY_CREATION_DATE,
	   --MOP.EXTN_ATTRIBUTE_CHAR004 O_JOB_REF_NO,
	   MOP.EXTN_ATTRIBUTE_CHAR003 O_JOB_REF_NO,
	   --ZSOH.EXTN_ATTRIBUTE_CHAR003 APPD_QUT_NO,
	   ZSOH.EXTERNAL_QUOTE_NUMBER APPD_QUT_NO,	   
	   --ZSOH.EXTN_ATTRIBUTE_TIMESTAMP001 APPD_QUT_DT,
	   TRUNC(ZSOH.CONTRACT_START_DATE) APPD_QUT_DT,
	   --MLL.EXTN_ATTRIBUTE_CHAR012 JOB_REF_NO,
	   MLL.EXTN_ATTRIBUTE_CHAR005 JOB_REF_NO,
	   ZSOH.EXTN_ATTRIBUTE_CHAR004 PROFIT_CENTER
From MKL_LM_LEADS MLL,
	 BU_V,
     FND_LOOKUP_VALUES_VL DIV_FLV,
	 MOO_OPTY_LEADS MOL,
	 MOO_OPTY MOP,
	 ZCA_SALES_ORDER_HEADERS ZSOH
 Where 1=1
  --And MLL.STATUS_CODE = 'CONVERTED'
  And MLL.BU_ID = BU_V.BU_ID
  And DIV_FLV.LOOKUP_TYPE = 'DIVISION'
  And MLL.EXTN_ATTRIBUTE_CHAR003 = DIV_FLV.LOOKUP_CODE
  And DIV_FLV.ENABLED_FLAG = 'Y'
  And (DIV_FLV.MEANING In (:P_DIV) Or Least (:P_DIV) Is Null)
  And MLL.LEAD_NUMBER = MOL.LEAD_NUMBER
  And MOL.OPTY_ID = MOP.OPTY_ID
  --And MLL.EXTN_ATTRIBUTE_CHAR012 = MOP.EXTN_ATTRIBUTE_CHAR004
  And MLL.EXTN_ATTRIBUTE_CHAR005 = MOP.EXTN_ATTRIBUTE_CHAR003
  And MLL.BU_ID = MOP.BU_ORG_ID
  And MLL.CUSTOMER_ID = MOP.CUST_PARTY_ID
  And MOP.OPTY_ID = ZSOH.OPTY_ID (+)
  --And ZSOH.STATUS(+) = 'ORDERED'
  And (MLL.LEAD_NUMBER In (:P_LEAD_NO) Or Least (:P_LEAD_NO) Is Null)
  And (MOP.OPTY_NUMBER In (:P_OPTY_NO) Or Least (:P_OPTY_NO) Is Null)
  And (ZSOH.EXTERNAL_QUOTE_NUMBER In (:P_QUOTE_NO) Or Least (:P_QUOTE_NO) Is Null)
  And (MLL.EXTN_ATTRIBUTE_CHAR005 In (:P_L_JOB_REF_NO) Or Least (:P_L_JOB_REF_NO) Is Null)
),
SO_V AS (
Select 
		DHA.ORDER_NUMBER SO_NO,
		DHA.SOLD_TO_PARTY_ID,
		DHA.ORG_ID,
		DHA.CREATION_DATE SO_CRE_DT,
		DHA.ORDERED_DATE SO_REL_DT,
        SO_FLV.MEANING SO_ORD_TYP,
		DHE.ATTRIBUTE_CHAR1 SO_JOB_REF_NO,
		DHE.ATTRIBUTE_CHAR2 SO_LEAD_NO,
		DHE.ATTRIBUTE_CHAR3 SO_OPTY_NO,
		DHE.ATTRIBUTE_CHAR4 SO_QUOTE_NO,
	    (Select SO_S.MEANING 
		 From FND_LOOKUP_VALUES_VL SO_S
		   Where SO_S.LOOKUP_TYPE = 'ORDER_STATUS'
			 And SO_S.ENABLED_FLAG = 'Y'
			 And SO_S.LOOKUP_CODE = DHA.STATUS_CODE ) SO_STATUS,
		(Select 
		  OKH.CONTRACT_NUMBER
		 From OKC_K_HEADERS_VL OKH
		   Where 1=1
		    And OKH.ID = DFLA.AGREEMENT_HEADER_ID
			And OKH.MAJOR_VERSION = DFLA.AGREEMENT_VERSION_NUMBER) SO_AGR_NO,
		 (Select 
		  OKL.LINE_NUMBER
		 From OKC_K_LINES_VL OKL
		   Where 1=1
		    And OKL.CHR_ID = DFLA.AGREEMENT_HEADER_ID
			And OKL.ID= DFLA.AGREEMENT_LINE_ID
			And OKL.MAJOR_VERSION = DFLA.AGREEMENT_VERSION_NUMBER) SO_AGR_LIN_NO,
	    /*(Select 
	      PAP.PERSON_NUMBER
	    From Per_Users PU,
		     Per_All_People_F PAP
		  Where 1=1
		    And PU.PERSON_ID = PAP.PERSON_ID
			And PU.END_DATE Is NULL
			And PU.USERNAME = DHA.CREATED_BY
			And Trunc(Sysdate) Between Trunc(PAP.EFFECTIVE_START_DATE) And Trunc(PAP.EFFECTIVE_END_DATE)) SE_EMP_NO,*/
	    Nvl((SELECT Distinct hp.party_number
			 FROM DOO_SALES_CREDITS DSC ,
				  JTF_RS_SALESREPS JRS  ,
				  HZ_PARTIES HP
			WHERE 1=1
			 AND dsc.salesperson_id = dfla.SALESPERSON_ID
			 AND dsc.salesperson_id = jrs.RESOURCE_ID
			 And dsc.PERCENT = '100'
			 AND Trunc(dha.creation_date) BETWEEN Trunc(jrs.START_DATE_ACTIVE) AND Trunc(jrs.end_date_active)
			 AND jrs.RESOURCE_ID = PARTY_ID),
		    (SELECT Distinct hp.party_number
			 FROM DOO_SALES_CREDITS DSC ,
				  JTF_RS_SALESREPS JRS  ,
				  HZ_PARTIES HP
			WHERE 1=1
			 AND DSC.header_id = DHA.header_id
			 AND dsc.salesperson_id = jrs.RESOURCE_ID
			 And dsc.PERCENT = '100'
			 AND Trunc(dha.creation_date) BETWEEN Trunc(jrs.START_DATE_ACTIVE) AND Trunc(jrs.end_date_active)
			 AND jrs.RESOURCE_ID = PARTY_ID)
		   ) SE_EMP_NO,
		/*(Select 
	      PPN.DISPLAY_NAME
	    From Per_Users PU,
		     Per_Person_Names_F PPN
		  Where 1=1
		    And PU.PERSON_ID = PPN.PERSON_ID
			And PU.END_DATE Is NULL
			And PPN.NAME_TYPE = 'GLOBAL'
			And PU.USERNAME = DHA.CREATED_BY
			And Trunc(Sysdate) Between Trunc(PPN.EFFECTIVE_START_DATE) And Trunc(PPN.EFFECTIVE_END_DATE)) SE_EMP_NAME,*/
		Nvl((SELECT Distinct hp.party_name
			 FROM DOO_SALES_CREDITS DSC ,
				  JTF_RS_SALESREPS JRS  ,
				  HZ_PARTIES HP
			WHERE 1=1
			 AND dsc.salesperson_id = dfla.SALESPERSON_ID
			 AND dsc.salesperson_id = jrs.RESOURCE_ID
			 And dsc.PERCENT = '100'
			 AND Trunc(dha.creation_date) BETWEEN Trunc(jrs.START_DATE_ACTIVE) AND Trunc(jrs.end_date_active)
			 AND jrs.RESOURCE_ID = PARTY_ID),
		    (SELECT Distinct hp.party_name
			 FROM DOO_SALES_CREDITS DSC ,
				  JTF_RS_SALESREPS JRS  ,
				  HZ_PARTIES HP
			WHERE 1=1
			 AND DSC.header_id = DHA.header_id
			 AND dsc.salesperson_id = jrs.RESOURCE_ID
			 And dsc.PERCENT = '100'
			 AND Trunc(dha.creation_date) BETWEEN Trunc(jrs.START_DATE_ACTIVE) AND Trunc(jrs.end_date_active)
			 AND jrs.RESOURCE_ID = PARTY_ID)
		   ) SE_EMP_NAME,
		DLA.LINE_NUMBER SO_LINE_NO,
		(Select SO_LINE_TYPE.MEANING 
		 From FND_LOOKUP_VALUES_VL SO_LINE_TYPE
		   Where SO_LINE_TYPE.LOOKUP_TYPE = 'ORA_DOO_LINE_TYPES'
			 And SO_LINE_TYPE.ENABLED_FLAG = 'Y'
			 And SO_LINE_TYPE.LOOKUP_CODE = DLA.LINE_TYPE_CODE
	    ) SO_LINE_TYPE,
		ESI.ITEM_NUMBER ITEM_CODE,
		Nvl(ESI.DESCRIPTION,ESI.LONG_DESCRIPTION) ITEM_DESC,
		ECV.CATEGORY_CODE,
		ECV.DESCRIPTION CATEGORY_DESC,
		IUOM.UNIT_OF_MEASURE,
		DLA.ORDERED_QTY,
		DHA.TRANSACTIONAL_CURRENCY_CODE SO_CURRENCY_CODE,
		DLA.UNIT_SELLING_PRICE SO_LINE_UNIT_PRICE,
		DLA.EXTENDED_AMOUNT SO_LINE_AMT,
		Nvl(DHA.CONVERSION_RATE,
			(Select GDR.CONVERSION_RATE
			 From GL_DAILY_RATES GDR
			  Where 1=1
			   And GDR.FROM_CURRENCY = DHA.TRANSACTIONAL_CURRENCY_CODE
			   And GDR.TO_CURRENCY = 'AED'
			   And Trunc(GDR.CONVERSION_DATE) = Trunc(DHA.CREATION_DATE)
			   And GDR.CONVERSION_TYPE = DHA.CONVERSION_TYPE_CODE
			)
			   ) SO_EXCH_RATE,
		(Select Sum(Nvl(DOT.TOTAL_AMOUNT,0))
		 From DOO_ORDER_TOTALS DOT
		  Where DOT.TOTAL_CODE in ('QP_TOTAL_NET_PRICE','QP_TOTAL_TAX')
		   And DOT.HEADER_ID = DHA.HEADER_ID
		) SO_TOT_AMT,
		DFLA.SHIPPED_QTY DISPATCH_QTY,
		(Select 
		   Sum(Nvl(DLA1.ORDERED_QTY,0)) Qty
		 From DOO_DOCUMENT_REFERENCES DDR1,
		      DOO_LINES_ALL DLA1
		  Where DDR1.DOC_REF_TYPE = 'ORIGINAL_SALES_ORDER'
		    And DDR1.DOC_ID = DLA.HEADER_ID
			And DDR1.DOC_LINE_ID=DLA.LINE_ID
			And DDR1.HEADER_ID = DLA1.HEADER_ID
			And DDR1.LINE_ID = DLA1.LINE_ID
			And DLA1.LINE_TYPE_CODE = 'ORA_RETURN') RETURN_QTY,
		(Select 
		   Sum(Nvl(RCTL.QUANTITY_INVOICED,0)) BILLED_QTY
		 From RA_CUSTOMER_TRX_LINES_ALL RCTL,DOO_FULFILL_LINE_DETAILS DFLD
		  Where RCTL.CUSTOMER_TRX_LINE_ID = DFLD.CUSTOMER_TRX_LINE_ID
		    And DFLD.FULFILL_LINE_ID = DFLA.FULFILL_LINE_ID
		    And DFLD.TASK_TYPE = 'Invoice'
			And DFLD.STATUS = 'BILLED') BILLED_QTY,
		(DLA.ORDERED_QTY - DFLA.SHIPPED_QTY) REMAIN_QTY,
		/*(Select SO_S.MEANING 
		 From FND_LOOKUP_VALUES_VL SO_S
		   Where SO_S.LOOKUP_TYPE = 'ORA_ZCA_SO_STATUS'--'ORDER_LINE_STATUS'
			 And SO_S.ENABLED_FLAG = 'Y'
			 --And SO_S.LOOKUP_CODE = DLA.STATUS_CODE
			 And SO_S.LOOKUP_CODE = DFLA.STATUS_CODE)*/ 
			 DLA.STATUS_CODE SO_LINE_STATUS,
		DFLA.FREIGHT_TERMS_CODE DELIVERY_TERMS,
		DHA.HEADER_ID SO_HEADER_ID,
		DLA.LINE_ID SO_LINE_ID,
		DFLA.FULFILL_LINE_ID,
		--DHE.ATTRIBUTE_CHAR1 SO_JOB_REF_NO,
		(Select 
		   DFLD.DELIVERY_NAME
		 From DOO_FULFILL_LINE_DETAILS DFLD
		  Where DFLD.FULFILL_LINE_ID = DFLA.FULFILL_LINE_ID
		    And DFLD.TASK_TYPE = 'Shipment'
			And DFLD.STATUS = 'SHIPPED') DELIV_ORD_NUM,
		DFLA.FULFILLMENT_DATE DELIV_DATE,
		(Select 
		   PPN.DISPLAY_NAME
		 From DOO_FULFILL_LINE_DETAILS DFLD,
			  Per_Users PU,
		      Per_Person_Names_F PPN
		  Where DFLD.FULFILL_LINE_ID = DFLA.FULFILL_LINE_ID
		    And DFLD.TASK_TYPE = 'Shipment'
			And DFLD.STATUS = 'SHIPPED'
			And DFLD.CREATED_BY = PU.USERNAME
			And PU.PERSON_ID = PPN.PERSON_ID
			And PU.END_DATE Is NULL
			And PPN.NAME_TYPE = 'GLOBAL'
			And Trunc(Sysdate) Between Trunc(PPN.EFFECTIVE_START_DATE) And Trunc(PPN.EFFECTIVE_END_DATE)
		) DELIV_PRP_NAME,
		Nvl(	(Select 
					 --Count(TO_NUMBER(DHI.TRANSACTION_ENTITY_ID1)) Cnt  
					 Decode(DHI.ACTIVE_FLAG,'Y','Yes','No') Flg
					 --MAX(DHI.TRANSACTION_ENTITY_ID1) TRANSACTION_ENTITY_ID1
				 From DOO_HOLD_INSTANCES DHI
				  Where 1=1
					And DHI.TRANSACTION_ENTITY_ID1 = DFLA.FULFILL_LINE_ID
					And DHI.TRANSACTION_ENTITY_NAME1 = 'DOO_ORDER_FLINES_V'
					And DHI.APPLY_SYSTEM = 'DOO'
					And DHI.APPLY_DATE = (Select Max(DHI1.APPLY_DATE)
										  From DOO_HOLD_INSTANCES DHI1
										   Where 1=1
										    And DHI1.TRANSACTION_ENTITY_ID1 = DFLA.FULFILL_LINE_ID
											And DHI1.TRANSACTION_ENTITY_NAME1 = 'DOO_ORDER_FLINES_V'
											And DHI1.APPLY_SYSTEM = 'DOO') 
					--And DHI.RELEASE_USER_ID Is Null				
				),'No')
		ORD_HOLD_FLG,
		(Select 
			TRUNC(DHI.APPLY_DATE) APPLY_DATE
		 From DOO_HOLD_INSTANCES DHI
		  Where 1=1
			And DHI.TRANSACTION_ENTITY_ID1 = DFLA.FULFILL_LINE_ID
			And DHI.TRANSACTION_ENTITY_NAME1 = 'DOO_ORDER_FLINES_V'
			And DHI.APPLY_SYSTEM = 'DOO'
			--And DHI.RELEASE_USER_ID Is Null
			And DHI.APPLY_DATE = (Select Max(DHI1.APPLY_DATE)
										  From DOO_HOLD_INSTANCES DHI1
										   Where 1=1
										    And DHI1.TRANSACTION_ENTITY_ID1 = DFLA.FULFILL_LINE_ID
											And DHI1.TRANSACTION_ENTITY_NAME1 = 'DOO_ORDER_FLINES_V'
											And DHI1.APPLY_SYSTEM = 'DOO') 
		) ORD_HOLD_DATE,
		(Select DHI.HOLD_COMMENTS
		 From DOO_HOLD_INSTANCES DHI
		  Where 1=1
			And DHI.TRANSACTION_ENTITY_ID1 = DFLA.FULFILL_LINE_ID
			And DHI.TRANSACTION_ENTITY_NAME1 = 'DOO_ORDER_FLINES_V'
			And DHI.APPLY_SYSTEM = 'DOO'
			--And DHI.RELEASE_USER_ID Is Null
			And DHI.APPLY_DATE = (Select Max(DHI1.APPLY_DATE)
										  From DOO_HOLD_INSTANCES DHI1
										   Where 1=1
										    And DHI1.TRANSACTION_ENTITY_ID1 = DFLA.FULFILL_LINE_ID
											And DHI1.TRANSACTION_ENTITY_NAME1 = 'DOO_ORDER_FLINES_V'
											And DHI1.APPLY_SYSTEM = 'DOO') 
		) ORD_HOLD_COMMENTS,
		(Select FLV.MEANING Hold_Reason
		 From DOO_HOLD_INSTANCES DHI,
			  --DOO_HOLD_CODES_VL DHC
			  FND_LOOKUP_VALUES_VL FLV
		  Where 1=1
			--And DHI.HOLD_RELEASE_REASON_CODE = DHC.HOLD_CODE
			And FLV.LOOKUP_TYPE = 'DOO_HLD_RELEASE_REASON'
			And DHI.HOLD_RELEASE_REASON_CODE = FLV.LOOKUP_CODE
			And FLV.ENABLED_FLAG = 'Y'
			And DHI.TRANSACTION_ENTITY_ID1 = DFLA.FULFILL_LINE_ID
			And DHI.TRANSACTION_ENTITY_NAME1 = 'DOO_ORDER_FLINES_V'
			And DHI.APPLY_SYSTEM = 'DOO'
			And DHI.RELEASE_DATE = (Select Max(DHI1.RELEASE_DATE)
										  From DOO_HOLD_INSTANCES DHI1
										   Where 1=1
										    And DHI1.TRANSACTION_ENTITY_ID1 = DFLA.FULFILL_LINE_ID
											And DHI1.TRANSACTION_ENTITY_NAME1 = 'DOO_ORDER_FLINES_V'
											And DHI1.APPLY_SYSTEM = 'DOO'
									)
			--And DHI.RELEASE_USER_ID Is Null	
		 
		) ORD_REL_REASON,
		(Select TRUNC(DHI.RELEASE_DATE) RELEASE_DATE
		 From DOO_HOLD_INSTANCES DHI
		  Where 1=1
			And DHI.TRANSACTION_ENTITY_ID1 = DFLA.FULFILL_LINE_ID
			And DHI.TRANSACTION_ENTITY_NAME1 = 'DOO_ORDER_FLINES_V'
			And DHI.APPLY_SYSTEM = 'DOO'
			--And DHI.RELEASE_USER_ID Is Null			
			And DHI.RELEASE_DATE = (Select Max(DHI1.RELEASE_DATE)
										  From DOO_HOLD_INSTANCES DHI1
										   Where 1=1
										    And DHI1.TRANSACTION_ENTITY_ID1 = DFLA.FULFILL_LINE_ID
											And DHI1.TRANSACTION_ENTITY_NAME1 = 'DOO_ORDER_FLINES_V'
											And DHI1.APPLY_SYSTEM = 'DOO')
		) ORD_HOLD_REL_DATE,
		(Select PPN.DISPLAY_NAME DISPLAY_NAME
		 From DOO_HOLD_INSTANCES DHI,
			  PER_USERS PU,
			  PER_PERSON_NAMES_F_V PPN
		  Where 1=1
			And DHI.TRANSACTION_ENTITY_ID1 = DFLA.FULFILL_LINE_ID
			And DHI.TRANSACTION_ENTITY_NAME1 = 'DOO_ORDER_FLINES_V'
			And DHI.APPLY_SYSTEM = 'DOO'
			--And DHI.RELEASE_USER_ID Is Null
			And DHI.RELEASE_USER_ID = PU.USER_GUID
			And PU.PERSON_ID = PPN.PERSON_ID
			And DHI.RELEASE_DATE = (Select Max(DHI1.RELEASE_DATE)
										  From DOO_HOLD_INSTANCES DHI1
										   Where 1=1
										    And DHI1.TRANSACTION_ENTITY_ID1 = DFLA.FULFILL_LINE_ID
											And DHI1.TRANSACTION_ENTITY_NAME1 = 'DOO_ORDER_FLINES_V'
											And DHI1.APPLY_SYSTEM = 'DOO')
		) ORD_HOLD_REL_BY
From DOO_HEADERS_ALL DHA,
     DOO_HEADERS_EFF_B DHE,
	 DOO_LINES_ALL DLA,
	 BU_V,
	 DOO_FULFILL_LINES_ALL DFLA,
	 FND_LOOKUP_VALUES_VL SO_FLV,
	 EGP_SYSTEM_ITEMS ESI,
	 EGP_ITEM_CATEGORIES EIC,
	 EGP_CATEGORIES_VL ECV,
	 INV_UNITS_OF_MEASURE_VL IUOM
 Where 1=1
  And DHA.HEADER_ID = DLA.HEADER_ID
  And DHA.HEADER_ID = DHE.HEADER_ID(+) 
  And DHE.CONTEXT_CODE(+) = 'AS SO Additional Information'
  And DHA.ORG_ID = BU_V.BU_ID
  And DHA.HEADER_ID = DFLA.HEADER_ID
  And DLA.LINE_ID = DFLA.LINE_ID
  And SO_FLV.LOOKUP_TYPE = 'ORA_DOO_ORDER_TYPES'
  And DHA.ORDER_TYPE_CODE = SO_FLV.LOOKUP_CODE
  And SO_FLV.ENABLED_FLAG = 'Y'
  And DLA.INVENTORY_ITEM_ID = ESI.INVENTORY_ITEM_ID
  And DLA.INVENTORY_ORGANIZATION_ID = ESI.ORGANIZATION_ID
  And ESI.INVENTORY_ITEM_ID = EIC.INVENTORY_ITEM_ID
  And ESI.ORGANIZATION_ID = EIC.ORGANIZATION_ID
  And EIC.CATEGORY_ID = ECV.CATEGORY_ID
  And ESI.PRIMARY_UOM_CODE = IUOM.UOM_CODE 
  And (DHA.ORDER_NUMBER In (:P_SO_NO) Or Least (:P_SO_NO) Is Null)
  And ECV.CATEGORY_CODE Between Nvl(:P_FROM_CAT,ECV.CATEGORY_CODE) And Nvl(:P_TO_CAT,ECV.CATEGORY_CODE)
  --And Trunc(DHA.CREATION_DATE) Between Nvl(:P_FROM_SO_DT,Trunc(DHA.CREATION_DATE)) And Nvl(:P_TO_SO_DT,Trunc(DHA.CREATION_DATE))
  --And (To_Date(Trunc(DHA.CREATION_DATE),'yyyy-MM-dd') Between Nvl(:P_FROM_SO_DT,To_Date(Trunc(DHA.CREATION_DATE),'yyyy-MM-dd')) And Nvl(:P_TO_SO_DT,To_Date(Trunc(DHA.CREATION_DATE),'yyyy-MM-dd')))
  And (To_Char(Trunc(DHA.CREATION_DATE),'yyyy-MM-dd') Between Nvl(:P_FROM_SO_DT,To_Char(Trunc(DHA.CREATION_DATE),'yyyy-MM-dd')) And Nvl(:P_TO_SO_DT,To_Char(Trunc(DHA.CREATION_DATE),'yyyy-MM-dd')))
  --And Trunc(DFLA.FULFILLMENT_DATE) Between Nvl(:P_FROM_DEL_DT,Trunc(DFLA.FULFILLMENT_DATE)) And Nvl(:P_TO_DEL_DT,Trunc(DFLA.FULFILLMENT_DATE))
  --And (To_Date(Trunc(DFLA.FULFILLMENT_DATE),'yyyy-MM-dd') Between Nvl(:P_FROM_DEL_DT,To_Date(Trunc(DFLA.FULFILLMENT_DATE),'yyyy-MM-dd')) And Nvl(:P_TO_DEL_DT,To_Date(Trunc(DFLA.FULFILLMENT_DATE),'yyyy-MM-dd')))
  --And (To_Date(Trunc(Nvl(DFLA.FULFILLMENT_DATE,SYSDATE)),'yyyy-MM-dd') Between Nvl(:P_FROM_DEL_DT,To_Date(Trunc(Nvl(DFLA.FULFILLMENT_DATE,SYSDATE)),'yyyy-MM-dd')) And Nvl(:P_TO_DEL_DT,To_Date(Trunc(Nvl(DFLA.FULFILLMENT_DATE,SYSDATE)),'yyyy-MM-dd')))
  And (To_Char(Trunc(Nvl(DFLA.FULFILLMENT_DATE,SYSDATE)),'yyyy-MM-dd') Between Nvl(:P_FROM_DEL_DT,To_Char(Trunc(Nvl(DFLA.FULFILLMENT_DATE,SYSDATE)),'yyyy-MM-dd')) And Nvl(:P_TO_DEL_DT,To_Char(Trunc(Nvl(DFLA.FULFILLMENT_DATE,SYSDATE)),'yyyy-MM-dd')))
),
PO_V As (
Select 
  DDR.HEADER_ID D_HEADER_ID,
  DDR.LINE_ID D_LINE_ID,
  DDR.FULFILL_LINE_ID D_FULFILL_LINE_ID,
  DDR.DOC_ID PO_HEADER_ID,
  DDR.DOC_USER_KEY PO_NUM,
  PSS.SEGMENT1 VENDOR_NUM,
  PSS.VENDOR_NAME,
  PSS.ATTRIBUTE1 ICV_VALUE
From DOO_DOCUMENT_REFERENCES DDR,
     PO_HEADERS_ALL PHA,
	 POZ_SUPPLIERS_V PSS
 Where DDR.DOC_REF_TYPE = 'DROPSHIP_PO_REFERENCE'
  And  DDR.DOC_ID = PHA.PO_HEADER_ID
  And  DDR.DOC_USER_KEY = PHA.SEGMENT1
  And  PHA.VENDOR_ID = PSS.VENDOR_ID
),
AR_INV_V As (
Select
  AR_INV.CUSTOMER_TRX_ID,
  AR_INV.INVOICE_TYPE,
  AR_INV.INV_NUM,
  AR_INV.I_SO_NO,
  AR_INV.INV_DATE,
  AR_INV.INV_DOC_SEQ_VAL,
  AR_INV.INV_E_CURR,
  AR_INV.TAX_RATE_CODE,
  AR_INV.TAX_RATE,
  AR_INV.I_EXCH_RATE,
  AR_INV.INV_TERMS,
  AR_INV.INV_TERM_DESC,
  AR_INV.INV_CRE_BY,
  SUM(NVL(AR_INV.SALES_AMT,0)) SALES_AMT,
  SUM(NVL(AR_INV.TAX_AMT,0)) TAX_AMT,
  SUM(NVL(AR_INV.SALES_AMOUNT_AED,0)) SALES_AMOUNT_AED,
  SUM(NVL(AR_INV.TAX_AMT_AED,0)) TAX_AMT_AED,
  SUM(NVL(AR_INV.SALES_TOT_AMT,0)) SALES_TOT_AMT,
  SUM(NVL(AR_INV.SALES_TOT_AMT_AED,0)) SALES_TOT_AMT_AED
From
(Select
  RCT.CUSTOMER_TRX_ID,
  RCTL.CUSTOMER_TRX_LINE_ID,
  RCTT.NAME INVOICE_TYPE,
  RCT.TRX_NUMBER INV_NUM,
  RCT.INTERFACE_HEADER_ATTRIBUTE3 I_SO_NO,
  RCT.TRX_DATE INV_DATE,
  RCT.DOC_SEQUENCE_VALUE INV_DOC_SEQ_VAL,
  RCT.INVOICE_CURRENCY_CODE INV_E_CURR,
  NVL(RCTL.EXTENDED_AMOUNT,0) SALES_AMT,
  Nvl(ZX_TAX.TAX_AMT,0) TAX_AMT,
  ZX_TAX.TAX_RATE_CODE TAX_RATE_CODE,
  ZX_TAX.TAX_RATE||'%' TAX_RATE,
  RCT.EXCHANGE_RATE I_EXCH_RATE,
  NVL(RCT.EXCHANGE_RATE,1)* NVL(RCTL.EXTENDED_AMOUNT,0) SALES_AMOUNT_AED,
  NVL(RCT.EXCHANGE_RATE,1)* NVL(ZX_TAX.TAX_AMT,0) TAX_AMT_AED,
  (NVL(RCTL.EXTENDED_AMOUNT,0) + Nvl(ZX_TAX.TAX_AMT,0)) SALES_TOT_AMT,
  (NVL(RCT.EXCHANGE_RATE,1)* NVL(RCTL.EXTENDED_AMOUNT,0) + NVL(RCT.EXCHANGE_RATE,1)* NVL(ZX_TAX.TAX_AMT,0)) SALES_TOT_AMT_AED,
  RTV.NAME INV_TERMS,
  RTV.DESCRIPTION INV_TERM_DESC,
  (Select 
	      PPN.DISPLAY_NAME
	    From Per_Users PU,
		     Per_Person_Names_F PPN
		  Where 1=1
		    And PU.PERSON_ID = PPN.PERSON_ID
			And PU.END_DATE Is NULL
			And PPN.NAME_TYPE = 'GLOBAL'
			And PU.USERNAME = RCT.CREATED_BY
			And Trunc(Sysdate) Between Trunc(PPN.EFFECTIVE_START_DATE) And Trunc(PPN.EFFECTIVE_END_DATE)) INV_CRE_BY  
From RA_CUSTOMER_TRX_ALL RCT,
     RA_CUST_TRX_TYPES_ALL RCTT,
     RA_CUSTOMER_TRX_LINES_ALL RCTL,
	 (SELECT NVL(SUM(ZL.TAX_AMT),0) TAX_AMT,ZL.TRX_LINE_ID,ZL.TAX_RATE,ZL.TAX_RATE_CODE,ZL.TRX_ID FROM ZX_LINES ZL,ZX_TAXES_B ZB 
	  WHERE ZL.TAX=ZB.TAX AND ZB.ALLOW_RECOVERABILITY_FLAG='Y' GROUP BY ZL.TRX_LINE_ID,ZL.TAX_RATE,ZL.TAX_RATE_CODE,ZL.TRX_ID) ZX_TAX,
	 RA_TERMS_VL RTV
 Where 1=1
  And RCT.CUST_TRX_TYPE_SEQ_ID = RCTT.CUST_TRX_TYPE_SEQ_ID
  And RCT.CUSTOMER_TRX_ID = RCTL.CUSTOMER_TRX_ID
  And RCTL.LINE_TYPE = 'LINE'
  And RCT.CUSTOMER_TRX_ID = ZX_TAX.TRX_ID(+)
  And RCTL.CUSTOMER_TRX_LINE_ID = ZX_TAX.TRX_LINE_ID(+)
  And RCT.TERM_ID = RTV.TERM_ID) AR_INV,
SO_V
Where AR_INV.I_SO_NO = SO_V.SO_NO
Group By
  AR_INV.CUSTOMER_TRX_ID,
  AR_INV.INVOICE_TYPE,
  AR_INV.INV_NUM,
  AR_INV.I_SO_NO,
  AR_INV.INV_DATE,
  AR_INV.INV_DOC_SEQ_VAL,
  AR_INV.INV_E_CURR,
  AR_INV.TAX_RATE_CODE,
  AR_INV.TAX_RATE,
  AR_INV.I_EXCH_RATE,
  AR_INV.INV_TERMS,
  AR_INV.INV_TERM_DESC,
  AR_INV.INV_CRE_BY
),
CSH_RCPT_V As (
Select
  ACRA.RECEIPT_DATE,
  (Select FLV.MEANING 
		 From FND_LOOKUP_VALUES_VL FLV
		   Where FLV.LOOKUP_TYPE = 'TRANSACTION TYPE'
			 And FLV.ENABLED_FLAG = 'Y'
			 And FLV.LOOKUP_CODE = ACRA.TYPE) RECEIPT_TYPE,
  ACRA.RECEIPT_NUMBER,
  ACRA.DOC_SEQUENCE_VALUE R_VCH_NO,
  ACRA.CURRENCY_CODE R_CURRENCY_CODE,
  Nvl(ACRA.AMOUNT,0) R_AMT,
  ACRA.EXCHANGE_RATE R_EXCH_RATE,
  (Nvl(ACRA.AMOUNT,0) * Nvl(ACRA.EXCHANGE_RATE,1)) R_AMT_AED,
  --ARPS.CUSTOMER_TRX_ID
  ARAA.APPLIED_CUSTOMER_TRX_ID CUSTOMER_TRX_ID
From AR_CASH_RECEIPTS_ALL ACRA,
     AR_PAYMENT_SCHEDULES_ALL ARPS,
	 AR_RECEIVABLE_APPLICATIONS_ALL ARAA,
	 AR_INV_V
Where ACRA.CASH_RECEIPT_ID = ARPS.CASH_RECEIPT_ID
  --And ARPS.CUSTOMER_TRX_ID = AR_INV_V.CUSTOMER_TRX_ID
  And ACRA.CASH_RECEIPT_ID = ARAA.CASH_RECEIPT_ID
  And ARPS.PAYMENT_SCHEDULE_ID = ARAA.PAYMENT_SCHEDULE_ID
  And ARAA.STATUS = 'APP'
  And ARAA.APPLIED_CUSTOMER_TRX_ID = AR_INV_V.CUSTOMER_TRX_ID
)
/*=================================ONLY LEAD =======================================*/
Select 
  --ROWNUM SR_NO,
  BU_V.BU_NAME,
  LEAD_OPP_V.DIVISION,
  CUST_DTL_V.ACCOUNT_NUMBER,
  CUST_DTL_V.PARTY_NAME,
  CUST_DTL_V.CONTACT_NAME,
  CUST_DTL_V.CONTACT_MAIL,
  CUST_DTL_V.CONTACT_PHONE,
  CUST_DTL_V.CUST_REG_NUMBER,
  --LEAD_OPP_V.L_SALES_ENGINEER,
  Null L_SALES_ENGINEER,
  LEAD_OPP_V.LEAD_NUMBER,
  LEAD_OPP_V.LEAD_NAME,
  LEAD_OPP_V.L_PREPARER,
  Trunc(LEAD_OPP_V.LEAD_CREATION_DATE) LEAD_CREATION_DATE,
  Trunc(LEAD_OPP_V.L_APPRD_DT) L_APPRD_DT,
  LEAD_OPP_V.L_APPR_STS,
  LEAD_OPP_V.OPTY_NUMBER,
  Trunc(LEAD_OPP_V.OPTY_CREATION_DATE) OPTY_CREATION_DATE,
  LEAD_OPP_V.APPD_QUT_NO,
  Trunc(LEAD_OPP_V.APPD_QUT_DT) APPD_QUT_DT,
  LEAD_OPP_V.L_JOB_REF_NO,
  LEAD_OPP_V.PROFIT_CENTER,
  Null SO_AGR_NO,
  Null SO_AGR_LIN_NO,
  Null SO_NO,
  Null SO_CRE_DT,
  Null SO_REL_DT,
  Null SO_ORD_TYP,
  Null SO_STATUS,
  Null SE_EMP_NO,
  Null SE_EMP_NAME,
  Null SO_LINE_NO,
  Null SO_LINE_TYPE,
  Null CATEGORY_CODE,
  Null CATEGORY_DESC,
  Null ITEM_CODE,
  Null ITEM_DESC,
  Null UNIT_OF_MEASURE,
  Null ORDERED_QTY,
  Null SO_CURRENCY_CODE,
  Null SO_LINE_UNIT_PRICE,
  Null SO_LINE_AMT,
  Null SO_EXCH_RATE,
  Null SO_TOT_AMT,
  Null DISPATCH_QTY,
  Null D_DISPATCH_QTY,
  Null RETURN_QTY,
  Null SO_REMAIN_QTY,
  Null BILLED_QTY,
  Null SO_LINE_STATUS,
  Null DELIVERY_TERMS,
  Null DELIV_ORD_NUM,
  Null DELIV_DATE,
  Null DELIV_PRP_NAME,
  Null PO_NUM,
  Null VENDOR_NUM,
  Null VENDOR_NAME,
  Null ICV_VALUE,
  Null ICV_VALUE_AED,
  Null INVOICE_TYPE,
  Null INV_NUM,
  Null INV_DATE,
  Null INV_DOC_SEQ_VAL,
  Null INV_E_CURR,
  Null SALES_AMT,
  Null TAX_RATE_CODE,
  Null TAX_AMT,
  Null SALES_TOT_AMT,
  Null I_EXCH_RATE,
  Null SALES_AMOUNT_AED,
  Null TAX_AMT_AED,
  Null SALES_TOT_AMT_AED,
  Null INV_TERMS,
  Null INV_TERM_DESC,
  Null INV_CRE_BY,
  Null RECEIPT_DATE,
  Null RECEIPT_TYPE,
  Null RECEIPT_NUMBER,
  Null R_VCH_NO,
  Null R_CURRENCY_CODE,
  Null R_AMT,
  Null R_EXCH_RATE,
  Null R_AMT_AED,
  Null ORD_HOLD_FLG,
  Null ORD_HOLD_DATE,
  Null ORD_HOLD_COMMENTS,
  Null ORD_REL_REASON,
  Null ORD_HOLD_REL_DATE,
  Null ORD_HOLD_REL_BY,
  Null FULFILL_LINE_ID
From BU_V,
	 LEAD_OPP_V,
     CUST_DTL_V/*,
	 SO_V,
	 PO_V,
	 AR_INV_V,
	 CSH_RCPT_V*/
  Where 1=1
    And BU_V.BU_ID = LEAD_OPP_V.L_BU_ID
	And LEAD_OPP_V.L_PARTY_ID = CUST_DTL_V.PARTY_ID
	/*And LEAD_OPP_V.L_JOB_REF_NO = SO_V.SO_JOB_REF_NO(+)
	And (SO_V.SO_AGR_NO In (:P_SO_AGR_NO) Or Least (:P_SO_AGR_NO) Is Null)
	And SO_V.SO_HEADER_ID = PO_V.D_HEADER_ID (+)
	And SO_V.SO_LINE_ID = PO_V.D_LINE_ID (+)
	And SO_V.FULFILL_LINE_ID = PO_V.D_FULFILL_LINE_ID (+)
	And SO_V.SO_NO = AR_INV_V.I_SO_NO (+)
	And AR_INV_V.CUSTOMER_TRX_ID = CSH_RCPT_V.CUSTOMER_TRX_ID (+)
	And (SO_V.SO_STATUS In (:P_SO_STATUS) Or Least (:P_SO_STATUS) Is Null)
	And (SO_V.SE_EMP_NAME In (:P_L_SE) Or Least (:P_L_SE) Is Null)*/
	And (LEAD_OPP_V.DIVISION In (:P_DIV) Or Least (:P_DIV) Is Null)
	And (LEAD_OPP_V.LEAD_NUMBER In (:P_LEAD_NO) Or Least (:P_LEAD_NO) Is Null)
	And (LEAD_OPP_V.OPTY_NUMBER In (:P_OPTY_NO) Or Least (:P_OPTY_NO) Is Null)
	And (LEAD_OPP_V.APPD_QUT_NO In (:P_QUOTE_NO) Or Least (:P_QUOTE_NO) Is Null)
	And (LEAD_OPP_V.L_JOB_REF_NO In (:P_L_JOB_REF_NO) Or Least (:P_L_JOB_REF_NO) Is Null)
	And Not Exists (Select Distinct 1 From SO_V Where SO_V.SO_JOB_REF_NO = LEAD_OPP_V.L_JOB_REF_NO)
/*=================================LEAD WITH SO =======================================*/
UNION	
Select 
  --ROWNUM SR_NO,
  BU_V.BU_NAME,
  LEAD_OPP_V.DIVISION,
  CUST_DTL_V.ACCOUNT_NUMBER,
  CUST_DTL_V.PARTY_NAME,
  CUST_DTL_V.CONTACT_NAME,
  CUST_DTL_V.CONTACT_MAIL,
  CUST_DTL_V.CONTACT_PHONE,
  CUST_DTL_V.CUST_REG_NUMBER,
  --LEAD_OPP_V.L_SALES_ENGINEER,
  SO_V.SE_EMP_NAME L_SALES_ENGINEER,
  LEAD_OPP_V.LEAD_NUMBER,
  LEAD_OPP_V.LEAD_NAME,
  LEAD_OPP_V.L_PREPARER,
  Trunc(LEAD_OPP_V.LEAD_CREATION_DATE) LEAD_CREATION_DATE,
  Trunc(LEAD_OPP_V.L_APPRD_DT) L_APPRD_DT,
  LEAD_OPP_V.L_APPR_STS,
  LEAD_OPP_V.OPTY_NUMBER,
  Trunc(LEAD_OPP_V.OPTY_CREATION_DATE) OPTY_CREATION_DATE,
  LEAD_OPP_V.APPD_QUT_NO,
  Trunc(LEAD_OPP_V.APPD_QUT_DT) APPD_QUT_DT,
  LEAD_OPP_V.L_JOB_REF_NO,
  LEAD_OPP_V.PROFIT_CENTER,
  SO_V.SO_AGR_NO,
  SO_V.SO_AGR_LIN_NO,
  SO_V.SO_NO,
  Trunc(SO_V.SO_CRE_DT) SO_CRE_DT,
  Trunc(SO_V.SO_REL_DT) SO_REL_DT,
  SO_V.SO_ORD_TYP,
  SO_V.SO_STATUS,
  SO_V.SE_EMP_NO,
  SO_V.SE_EMP_NAME,
  SO_V.SO_LINE_NO,
  SO_V.SO_LINE_TYPE,
  SO_V.CATEGORY_CODE,
  SO_V.CATEGORY_DESC,
  SO_V.ITEM_CODE,
  SO_V.ITEM_DESC,
  SO_V.UNIT_OF_MEASURE,
  SO_V.ORDERED_QTY,
  SO_V.SO_CURRENCY_CODE,
  SO_V.SO_LINE_UNIT_PRICE,
  SO_V.SO_LINE_AMT,
  SO_V.SO_EXCH_RATE,
  (Case When SO_V.SO_CURRENCY_CODE = 'AED' 
	   Then SO_V.SO_TOT_AMT
	   Else (SO_V.SO_TOT_AMT * SO_V.SO_EXCH_RATE) End)SO_TOT_AMT,
  SO_V.DISPATCH_QTY,
  SO_V.DISPATCH_QTY D_DISPATCH_QTY,
  SO_V.RETURN_QTY,
  (SO_V.REMAIN_QTY + SO_V.RETURN_QTY) SO_REMAIN_QTY,
  SO_V.BILLED_QTY,
  SO_V.SO_LINE_STATUS,
  SO_V.DELIVERY_TERMS,
  SO_V.DELIV_ORD_NUM,
  Trunc(SO_V.DELIV_DATE) DELIV_DATE,
  SO_V.DELIV_PRP_NAME,
  PO_V.PO_NUM,
  PO_V.VENDOR_NUM,
  PO_V.VENDOR_NAME,
  PO_V.ICV_VALUE,
  (PO_V.ICV_VALUE * Nvl(AR_INV_V.I_EXCH_RATE,1)) ICV_VALUE_AED,
  AR_INV_V.INVOICE_TYPE,
  AR_INV_V.INV_NUM,
  Trunc(AR_INV_V.INV_DATE) INV_DATE,
  AR_INV_V.INV_DOC_SEQ_VAL,
  AR_INV_V.INV_E_CURR,
  AR_INV_V.SALES_AMT,
  AR_INV_V.TAX_RATE_CODE,
  AR_INV_V.TAX_AMT,
  AR_INV_V.SALES_TOT_AMT,
  AR_INV_V.I_EXCH_RATE,
  AR_INV_V.SALES_AMOUNT_AED,
  AR_INV_V.TAX_AMT_AED,
  AR_INV_V.SALES_TOT_AMT_AED,
  AR_INV_V.INV_TERMS,
  AR_INV_V.INV_TERM_DESC,
  AR_INV_V.INV_CRE_BY,
  Trunc(CSH_RCPT_V.RECEIPT_DATE) RECEIPT_DATE,
  CSH_RCPT_V.RECEIPT_TYPE,
  CSH_RCPT_V.RECEIPT_NUMBER,
  CSH_RCPT_V.R_VCH_NO,
  CSH_RCPT_V.R_CURRENCY_CODE,
  CSH_RCPT_V.R_AMT,
  CSH_RCPT_V.R_EXCH_RATE,
  CSH_RCPT_V.R_AMT_AED,
  SO_V.ORD_HOLD_FLG,
  SO_V.ORD_HOLD_DATE,
  SO_V.ORD_HOLD_COMMENTS,
  SO_V.ORD_REL_REASON,
  SO_V.ORD_HOLD_REL_DATE,
  SO_V.ORD_HOLD_REL_BY,
  SO_V.FULFILL_LINE_ID
From BU_V,
	 LEAD_OPP_V,
     CUST_DTL_V,
	 SO_V,
	 PO_V,
	 AR_INV_V,
	 CSH_RCPT_V
  Where 1=1
    And BU_V.BU_ID = LEAD_OPP_V.L_BU_ID
	And LEAD_OPP_V.L_PARTY_ID = CUST_DTL_V.PARTY_ID
	And LEAD_OPP_V.L_JOB_REF_NO = SO_V.SO_JOB_REF_NO
	And LEAD_OPP_V.LEAD_NUMBER = SO_V.SO_LEAD_NO
	And LEAD_OPP_V.OPTY_NUMBER = SO_V.SO_OPTY_NO
	And LEAD_OPP_V.APPD_QUT_NO = SO_V.SO_QUOTE_NO
	And (SO_V.SO_NO In (:P_SO_NO) Or Least (:P_SO_NO) Is Null)
	And (SO_V.SO_AGR_NO In (:P_SO_AGR_NO) Or Least (:P_SO_AGR_NO) Is Null)
	And SO_V.SO_HEADER_ID = PO_V.D_HEADER_ID (+)
	And SO_V.SO_LINE_ID = PO_V.D_LINE_ID (+)
	And SO_V.FULFILL_LINE_ID = PO_V.D_FULFILL_LINE_ID (+)
	And SO_V.SO_NO = AR_INV_V.I_SO_NO (+)
	And AR_INV_V.CUSTOMER_TRX_ID = CSH_RCPT_V.CUSTOMER_TRX_ID (+)
	And (SO_V.SO_STATUS In (:P_SO_STATUS) Or Least (:P_SO_STATUS) Is Null)
	And (SO_V.SE_EMP_NAME In (:P_L_SE) Or Least (:P_L_SE) Is Null)
/*=================================ONLY SO =======================================*/
UNION
Select 
  --ROWNUM SR_NO,
  BU_V.BU_NAME,
  Null DIVISION,
  CUST_DTL_V.ACCOUNT_NUMBER,
  CUST_DTL_V.PARTY_NAME,
  CUST_DTL_V.CONTACT_NAME,
  CUST_DTL_V.CONTACT_MAIL,
  CUST_DTL_V.CONTACT_PHONE,
  CUST_DTL_V.CUST_REG_NUMBER,
  --LEAD_OPP_V.L_SALES_ENGINEER,
  SO_V.SE_EMP_NAME L_SALES_ENGINEER,
  Null LEAD_NUMBER,
  Null LEAD_NAME,
  Null L_PREPARER,
  Null LEAD_CREATION_DATE,
  Null L_APPRD_DT,
  Null L_APPR_STS,
  Null OPTY_NUMBER,
  Null OPTY_CREATION_DATE,
  Null APPD_QUT_NO,
  Null APPD_QUT_DT,
  SO_V.SO_JOB_REF_NO L_JOB_REF_NO,
  Null PROFIT_CENTER,
  SO_V.SO_AGR_NO,
  SO_V.SO_AGR_LIN_NO,
  SO_V.SO_NO,
  Trunc(SO_V.SO_CRE_DT) SO_CRE_DT,
  Trunc(SO_V.SO_REL_DT) SO_REL_DT,
  SO_V.SO_ORD_TYP,
  SO_V.SO_STATUS,
  SO_V.SE_EMP_NO,
  SO_V.SE_EMP_NAME,
  SO_V.SO_LINE_NO,
  SO_V.SO_LINE_TYPE,
  SO_V.CATEGORY_CODE,
  SO_V.CATEGORY_DESC,
  SO_V.ITEM_CODE,
  SO_V.ITEM_DESC,
  SO_V.UNIT_OF_MEASURE,
  SO_V.ORDERED_QTY,
  SO_V.SO_CURRENCY_CODE,
  SO_V.SO_LINE_UNIT_PRICE,
  SO_V.SO_LINE_AMT,
  SO_V.SO_EXCH_RATE,
  SO_V.SO_TOT_AMT,
  SO_V.DISPATCH_QTY,
  SO_V.DISPATCH_QTY D_DISPATCH_QTY,
  SO_V.RETURN_QTY,
  (SO_V.REMAIN_QTY + SO_V.RETURN_QTY) SO_REMAIN_QTY,
  SO_V.BILLED_QTY,
  SO_V.SO_LINE_STATUS,
  SO_V.DELIVERY_TERMS,
  SO_V.DELIV_ORD_NUM,
  Trunc(SO_V.DELIV_DATE) DELIV_DATE,
  SO_V.DELIV_PRP_NAME,
  PO_V.PO_NUM,
  PO_V.VENDOR_NUM,
  PO_V.VENDOR_NAME,
  PO_V.ICV_VALUE,
  (PO_V.ICV_VALUE * Nvl(AR_INV_V.I_EXCH_RATE,1)) ICV_VALUE_AED,
  AR_INV_V.INVOICE_TYPE,
  AR_INV_V.INV_NUM,
  Trunc(AR_INV_V.INV_DATE) INV_DATE,
  AR_INV_V.INV_DOC_SEQ_VAL,
  AR_INV_V.INV_E_CURR,
  AR_INV_V.SALES_AMT,
  AR_INV_V.TAX_RATE_CODE,
  AR_INV_V.TAX_AMT,
  AR_INV_V.SALES_TOT_AMT,
  AR_INV_V.I_EXCH_RATE,
  AR_INV_V.SALES_AMOUNT_AED,
  AR_INV_V.TAX_AMT_AED,
  AR_INV_V.SALES_TOT_AMT_AED,
  AR_INV_V.INV_TERMS,
  AR_INV_V.INV_TERM_DESC,
  AR_INV_V.INV_CRE_BY,
  Trunc(CSH_RCPT_V.RECEIPT_DATE) RECEIPT_DATE,
  CSH_RCPT_V.RECEIPT_TYPE,
  CSH_RCPT_V.RECEIPT_NUMBER,
  CSH_RCPT_V.R_VCH_NO,
  CSH_RCPT_V.R_CURRENCY_CODE,
  CSH_RCPT_V.R_AMT,
  CSH_RCPT_V.R_EXCH_RATE,
  CSH_RCPT_V.R_AMT_AED,
  SO_V.ORD_HOLD_FLG,
  SO_V.ORD_HOLD_DATE,
  SO_V.ORD_HOLD_COMMENTS,
  SO_V.ORD_REL_REASON,
  SO_V.ORD_HOLD_REL_DATE,
  SO_V.ORD_HOLD_REL_BY,
  SO_V.FULFILL_LINE_ID
From BU_V,
	 --LEAD_OPP_V,
     CUST_DTL_V,
	 SO_V,
	 PO_V,
	 AR_INV_V,
	 CSH_RCPT_V
  Where 1=1
    And BU_V.BU_ID = SO_V.ORG_ID
	And CUST_DTL_V.PARTY_ID = SO_V.SOLD_TO_PARTY_ID
	And (SO_V.SO_NO In (:P_SO_NO) Or Least (:P_SO_NO) Is Null)
	And (SO_V.SO_AGR_NO In (:P_SO_AGR_NO) Or Least (:P_SO_AGR_NO) Is Null)
	And SO_V.SO_HEADER_ID = PO_V.D_HEADER_ID (+)
	And SO_V.SO_LINE_ID = PO_V.D_LINE_ID (+)
	And SO_V.FULFILL_LINE_ID = PO_V.D_FULFILL_LINE_ID (+)
	And SO_V.SO_NO = AR_INV_V.I_SO_NO (+)
	And AR_INV_V.CUSTOMER_TRX_ID = CSH_RCPT_V.CUSTOMER_TRX_ID (+)
	And (SO_V.SO_STATUS In (:P_SO_STATUS) Or Least (:P_SO_STATUS) Is Null)
	And (SO_V.SE_EMP_NAME In (:P_L_SE) Or Least (:P_L_SE) Is Null)
	And Not Exists (Select Distinct 1 From LEAD_OPP_V Where LEAD_OPP_V.L_JOB_REF_NO = SO_V.SO_JOB_REF_NO)
	--ANd SO_V.SO_NO = '191'
) SOD	
Where 1=1
 And (SOD.BU_NAME In (:P_BU_NAME) Or Least (:P_BU_NAME) Is Null) 
 And (SOD.LEAD_NUMBER In (:P_LEAD_NO) Or Least (:P_LEAD_NO) Is Null)
 --And SOD.LEAD_NUMBER = '149016'
 And (SOD.OPTY_NUMBER In (:P_OPTY_NO) Or Least (:P_OPTY_NO) Is Null)
 And (SOD.APPD_QUT_NO In (:P_QUOTE_NO) Or Least (:P_QUOTE_NO) Is Null)
 And (SOD.L_JOB_REF_NO In (:P_L_JOB_REF_NO) Or Least (:P_L_JOB_REF_NO) Is Null)
 And (SOD.DIVISION In (:P_DIV) Or Least (:P_DIV) Is Null)
 And (SOD.SE_EMP_NAME In (:P_L_SE) Or Least (:P_L_SE) Is Null)
 And (SOD.PARTY_NAME In (:P_PARTY_NAME) Or Least (:P_PARTY_NAME) Is Null)
 And (SOD.SO_STATUS In (:P_SO_STATUS) Or Least (:P_SO_STATUS) Is Null)
 And (SOD.SO_NO In (:P_SO_NO) Or Least (:P_SO_NO) Is Null)
 And (SOD.SO_AGR_NO In (:P_SO_AGR_NO) Or Least (:P_SO_AGR_NO) Is Null)
 And Nvl(SOD.CATEGORY_CODE,'XXXX') Between Nvl(:P_FROM_CAT,Nvl(SOD.CATEGORY_CODE,'XXXX')) And Nvl(:P_TO_CAT,Nvl(SOD.CATEGORY_CODE,'XXXX'))
 --And (To_Date(Trunc(Nvl(SOD.SO_CRE_DT,Sysdate)),'yyyy-MM-dd') Between Nvl(:P_FROM_SO_DT,To_Date(Trunc(Nvl(SOD.SO_CRE_DT,Sysdate)),'yyyy-MM-dd')) And Nvl(:P_TO_SO_DT,To_Date(Trunc(Nvl(SOD.SO_CRE_DT,Sysdate)),'yyyy-MM-dd'))) 
 And (To_Char(Trunc(Nvl(SOD.SO_CRE_DT,Sysdate)),'yyyy-MM-dd') Between Nvl(:P_FROM_SO_DT,To_Char(Trunc(Nvl(SOD.SO_CRE_DT,Sysdate)),'yyyy-MM-dd')) And Nvl(:P_TO_SO_DT,To_Char(Trunc(Nvl(SOD.SO_CRE_DT,Sysdate)),'yyyy-MM-dd'))) 
 --And (To_Date(Trunc(Nvl(SOD.DELIV_DATE,SYSDATE)),'yyyy-MM-dd') Between Nvl(:P_FROM_DEL_DT,To_Date(Trunc(Nvl(SOD.DELIV_DATE,SYSDATE)),'yyyy-MM-dd')) And Nvl(:P_TO_DEL_DT,To_Date(Trunc(Nvl(SOD.DELIV_DATE,SYSDATE)),'yyyy-MM-dd')))
 And (To_Char(Trunc(Nvl(SOD.DELIV_DATE,SYSDATE)),'yyyy-MM-dd') Between Nvl(:P_FROM_DEL_DT,To_Char(Trunc(Nvl(SOD.DELIV_DATE,SYSDATE)),'yyyy-MM-dd')) And Nvl(:P_TO_DEL_DT,To_Char(Trunc(Nvl(SOD.DELIV_DATE,SYSDATE)),'yyyy-MM-dd')))
--Order by rownum asc
Order by 
	SOD.LEAD_NUMBER Asc NULLS Last,
	SOD.OPTY_NUMBER Asc NULLS Last,
	SOD.APPD_QUT_NO Asc NULLS Last,
	SOD.SO_NO Asc NULLS Last
