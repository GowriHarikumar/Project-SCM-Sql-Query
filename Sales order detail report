SELECT
    ROWNUM sr_no,
    sod.bu_name,
    sod.division,
    sod.account_number,
    sod.party_name,
    sod.contact_name,
    sod.contact_mail,
    sod.contact_phone,
    sod.cust_reg_number,
  --LEAD_OPP_V.L_SALES_ENGINEER,
    sod.l_sales_engineer,
    sod.lead_number,
    sod.lead_name,
    sod.l_preparer,
    sod.lead_creation_date,
    sod.l_apprd_dt,
    sod.l_appr_sts,
    sod.opty_number,
    sod.opty_creation_date,
    sod.appd_qut_no,
    sod.appd_qut_dt,
    sod.l_job_ref_no,
    sod.profit_center,
    sod.so_agr_no,
    sod.so_agr_lin_no,
    sod.so_no,
    sod.so_cre_dt,
    sod.so_rel_dt,
    sod.so_ord_typ,
    sod.so_status,
    sod.se_emp_no,
    sod.se_emp_name,
    sod.so_line_no,
    sod.so_line_type,
    sod.category_code,
    sod.category_desc,
    sod.item_code,
    sod.item_desc,
    sod.unit_of_measure,
    sod.ordered_qty,
    sod.so_currency_code,
    sod.so_line_unit_price,
    sod.so_line_amt,
    sod.so_exch_rate,
    sod.so_tot_amt,
    sod.dispatch_qty,
    sod.d_dispatch_qty,
    sod.return_qty,
    sod.so_remain_qty so_remain_qty,
    sod.billed_qty,
    sod.so_line_status,
    sod.delivery_terms,
    sod.deliv_ord_num,
    sod.deliv_date,
    sod.deliv_prp_name,
    sod.po_num,
    sod.vendor_num,
    sod.vendor_name,
    sod.icv_value,
    sod.icv_value_aed,
    sod.invoice_type,
    sod.inv_num,
    sod.inv_date,
    sod.inv_doc_seq_val,
    sod.inv_e_curr,
    sod.sales_amt,
    sod.tax_rate_code,
    sod.tax_amt,
    sod.sales_tot_amt,
    sod.i_exch_rate,
    sod.sales_amount_aed,
    sod.tax_amt_aed,
    sod.sales_tot_amt_aed,
    sod.inv_terms,
    sod.inv_term_desc,
    sod.inv_cre_by,
    sod.receipt_date,
    sod.receipt_type,
    sod.receipt_number,
    sod.r_vch_no,
    sod.r_currency_code,
    sod.r_amt,
    sod.r_exch_rate,
    sod.r_amt_aed,
    sod.ord_hold_flg,
    sod.ord_hold_date,
    sod.ord_hold_comments,
    sod.ord_rel_reason,
    sod.ord_hold_rel_date,
    sod.ord_hold_rel_by,
    sod.fulfill_line_id
FROM
    (
        WITH bu_v AS (
            SELECT DISTINCT
                hou.organization_id   bu_id,
                hou.name              bu_name/*,
				ZXR.TAX_REGIME_CODE TAX_REGIME*/
            FROM
                hr_operating_units hou/*,
		 ZX_PARTY_TAX_PROFILE ZPTP,
		 ZX_REGIMES_USAGES ZRU,
		 ZX_REGIMES_B ZXR*/
            WHERE
                ( hou.name IN (
                    :p_bu_name
                )
                  OR least(:p_bu_name) IS NULL )
	  /*And HOU.ORGANIZATION_ID = ZPTP.PARTY_ID
	  And ZPTP.PARTY_TAX_PROFILE_ID = ZRU.FIRST_PTY_ORG_ID
	  And ZXR.REGIME_TYPE_FLAG = 'I'
	  And Trunc(SYSDATE) Between Nvl(ZXR.EFFECTIVE_FROM,Trunc(SYSDATE)-1) And Nvl(ZXR.EFFECTIVE_TO,Trunc(SYSDATE)+1)
	  And ZXR.TAX_REGIME_CODE = ZRU.TAX_REGIME_CODE*/
        ), cust_dtl_v AS (
            SELECT DISTINCT
                hp.party_id,
                hp.party_number,
                hp.party_name,
                hps.party_site_id,
                hps.party_site_number,
                hca.cust_account_id,
                hca.account_number,
                hcas.cust_acct_site_id,
	   --HCSU.SITE_USE_ID,
                (
                    SELECT
                        hp_c.person_first_name
                        || ' '
                        || hp_c.person_last_name
                    FROM
                        hz_parties hp_c
                    WHERE
                        hp_c.party_type = 'PERSON'
                        AND hp_c.party_id = hp.preferred_contact_person_id
                ) contact_name,
                (
                    SELECT DISTINCT
                        hcp.email_address
		  --LISTAGG(HCP.EMAIL_ADDRESS, '/')WITHIN GROUP (ORDER BY HCP.OWNER_TABLE_ID) EMAIL_ADDRESS
                    FROM
                        hz_contact_points hcp
                    WHERE
                        hcp.owner_table_name = 'HZ_PARTIES'
                        AND hcp.contact_point_type = 'EMAIL'
                        AND hcp.phone_line_type IS NULL
                        AND hcp.status = 'A'
                        AND hcp.primary_flag = 'Y'
                        AND hcp.owner_table_id = hp.preferred_contact_person_id
                        AND ROWNUM = 1
                ) contact_mail,
                (
                    SELECT
                        CASE
                            WHEN hcp.raw_phone_number IS NOT NULL THEN
                                '+'
                                || ''
                                || hcp.raw_phone_number
                            ELSE
                                hcp.raw_phone_number
                        END ph_no
                    FROM
                        hz_contact_points hcp
                    WHERE
                        hcp.owner_table_name = 'HZ_PARTIES'
                        AND hcp.contact_point_type = 'PHONE'
                        AND hcp.phone_line_type = 'MOBILE'
                        AND hcp.status = 'A'
                        AND hcp.owner_table_id = hp.preferred_contact_person_id
                ) contact_phone,
                hp.jgzz_fiscal_code cust_reg_number
            FROM
                hz_parties               hp,
                hz_party_sites           hps,
                hz_cust_accounts         hca,
                hz_cust_acct_sites_all   hcas,
                hz_cust_site_uses_all    hcsu--,
	 --BU_V
            WHERE
                1 = 1
                AND hp.party_id = hps.party_id
                AND hp.party_id = hca.party_id
                AND hps.party_site_id = hcas.party_site_id
                AND hca.cust_account_id = hcas.cust_account_id
                AND hcas.cust_acct_site_id = hcsu.cust_acct_site_id
                AND hcsu.primary_flag = 'Y'
                AND hcsu.site_use_code = 'BILL_TO'
                AND trunc(SYSDATE) BETWEEN trunc(hps.start_date_active) AND trunc(hps.end_date_active)
                AND trunc(SYSDATE) BETWEEN trunc(hcas.start_date) AND trunc(hcas.end_date)
                AND trunc(SYSDATE) BETWEEN trunc(hcsu.start_date) AND trunc(hcsu.end_date)
 --AND HCAS.SET_ID = FND_SETID_UTILITY.GETSETID ('HZ_CUSTOMER_ACCOUNT_SITE','BU',BU_V.BU_ID ) 
 --AND HCAS.SET_ID = FND_SETID_UTILITY.GETSETID ('HZ_CUSTOMER_ACCOUNT_SITE','BU',(SELECT Distinct BU_ID FROM BU_V) )
                AND ( hp.party_name IN (
                    :p_party_name
                )
                      OR least(:p_party_name) IS NULL )
        ), lead_opp_v AS (
            SELECT
                mll.lead_number,
                mll.lead_name,
                mll.customer_id               l_party_id,
	   /*(Select 
	      PPN.DISPLAY_NAME
	    From Per_Users PU,
		     Per_Person_Names_F PPN
		  Where 1=1
		    And PU.PERSON_ID = PPN.PERSON_ID
			And PU.END_DATE Is NULL
			And PPN.NAME_TYPE = 'GLOBAL'
			And PU.USERNAME = MLL.LEAD_CREATED_BY
			And Trunc(Sysdate) Between Trunc(PPN.EFFECTIVE_START_DATE) And Trunc(PPN.EFFECTIVE_END_DATE)) L_SALES_ENGINEER,*/
                mll.lead_creation_date,
                (
                    SELECT
                        ppn.display_name
                    FROM
                        per_users            pu,
                        per_person_names_f   ppn
                    WHERE
                        1 = 1
                        AND pu.person_id = ppn.person_id
                        AND pu.end_date IS NULL
                        AND ppn.name_type = 'GLOBAL'
                        AND pu.username = mll.created_by
                        AND trunc(SYSDATE) BETWEEN trunc(ppn.effective_start_date) AND trunc(ppn.effective_end_date)
                ) l_preparer,
                mll.approval_date             l_apprd_dt,
                mll.approval_status           l_appr_sts,
	   --MLL.EXTN_ATTRIBUTE_CHAR012 L_JOB_REF_NO,
                mll.extn_attribute_char005    l_job_ref_no,
                div_flv.meaning               division,
                mll.bu_id                     l_bu_id,
                mll.customer_id               l_customer_id,
                mop.opty_number,
                mop.opty_creation_date,
	   --MOP.EXTN_ATTRIBUTE_CHAR004 O_JOB_REF_NO,
                mop.extn_attribute_char003    o_job_ref_no,
	   --ZSOH.EXTN_ATTRIBUTE_CHAR003 APPD_QUT_NO,
                zsoh.external_quote_number    appd_qut_no,	   
	   --ZSOH.EXTN_ATTRIBUTE_TIMESTAMP001 APPD_QUT_DT,
                trunc(zsoh.contract_start_date) appd_qut_dt,
	   --MLL.EXTN_ATTRIBUTE_CHAR012 JOB_REF_NO,
                mll.extn_attribute_char005    job_ref_no,
                zsoh.extn_attribute_char004   profit_center
            FROM
                mkl_lm_leads              mll,
                bu_v,
                fnd_lookup_values_vl      div_flv,
                moo_opty_leads            mol,
                moo_opty                  mop,
                zca_sales_order_headers   zsoh
            WHERE
                1 = 1
  --And MLL.STATUS_CODE = 'CONVERTED'
                AND mll.bu_id = bu_v.bu_id
                AND div_flv.lookup_type = 'DIVISION'
                AND mll.extn_attribute_char003 = div_flv.lookup_code
                AND div_flv.enabled_flag = 'Y'
                AND ( div_flv.meaning IN (
                    :p_div
                )
                      OR least(:p_div) IS NULL )
                AND mll.lead_number = mol.lead_number
                AND mol.opty_id = mop.opty_id
  --And MLL.EXTN_ATTRIBUTE_CHAR012 = MOP.EXTN_ATTRIBUTE_CHAR004
                AND mll.extn_attribute_char005 = mop.extn_attribute_char003
                AND mll.bu_id = mop.bu_org_id
                AND mll.customer_id = mop.cust_party_id
                AND mop.opty_id = zsoh.opty_id (+)
  --And ZSOH.STATUS(+) = 'ORDERED'
                AND ( mll.lead_number IN (
                    :p_lead_no
                )
                      OR least(:p_lead_no) IS NULL )
                AND ( mop.opty_number IN (
                    :p_opty_no
                )
                      OR least(:p_opty_no) IS NULL )
                AND ( zsoh.external_quote_number IN (
                    :p_quote_no
                )
                      OR least(:p_quote_no) IS NULL )
                AND ( mll.extn_attribute_char005 IN (
                    :p_l_job_ref_no
                )
                      OR least(:p_l_job_ref_no) IS NULL )
        ), so_v AS (
            SELECT
                dha.order_number                  so_no,
                dha.sold_to_party_id,
                dha.org_id,
                dha.creation_date                 so_cre_dt,
                dha.ordered_date                  so_rel_dt,
                so_flv.meaning                    so_ord_typ,
                dhe.attribute_char1               so_job_ref_no,
                dhe.attribute_char2               so_lead_no,
                dhe.attribute_char3               so_opty_no,
                dhe.attribute_char4               so_quote_no,
                (
                    SELECT
                        so_s.meaning
                    FROM
                        fnd_lookup_values_vl so_s
                    WHERE
                        so_s.lookup_type = 'ORDER_STATUS'
                        AND so_s.enabled_flag = 'Y'
                        AND so_s.lookup_code = dha.status_code
                ) so_status,
                (
                    SELECT
                        okh.contract_number
                    FROM
                        okc_k_headers_vl okh
                    WHERE
                        1 = 1
                        AND okh.id = dfla.agreement_header_id
                        AND okh.major_version = dfla.agreement_version_number
                ) so_agr_no,
                (
                    SELECT
                        okl.line_number
                    FROM
                        okc_k_lines_vl okl
                    WHERE
                        1 = 1
                        AND okl.chr_id = dfla.agreement_header_id
                        AND okl.id = dfla.agreement_line_id
                        AND okl.major_version = dfla.agreement_version_number
                ) so_agr_lin_no,
	    /*(Select 
	      PAP.PERSON_NUMBER
	    From Per_Users PU,
		     Per_All_People_F PAP
		  Where 1=1
		    And PU.PERSON_ID = PAP.PERSON_ID
			And PU.END_DATE Is NULL
			And PU.USERNAME = DHA.CREATED_BY
			And Trunc(Sysdate) Between Trunc(PAP.EFFECTIVE_START_DATE) And Trunc(PAP.EFFECTIVE_END_DATE)) SE_EMP_NO,*/
                nvl((
                    SELECT DISTINCT
                        hp.party_number
                    FROM
                        doo_sales_credits   dsc, jtf_rs_salesreps    jrs, hz_parties          hp
                    WHERE
                        1 = 1
                        AND dsc.salesperson_id = dfla.salesperson_id
                        AND dsc.salesperson_id = jrs.resource_id
                        AND dsc.percent = '100'
                        AND trunc(dha.creation_date) BETWEEN trunc(jrs.start_date_active) AND trunc(jrs.end_date_active)
                        AND jrs.resource_id = party_id
                ),(
                    SELECT DISTINCT
                        hp.party_number
                    FROM
                        doo_sales_credits   dsc, jtf_rs_salesreps    jrs, hz_parties          hp
                    WHERE
                        1 = 1
                        AND dsc.header_id = dha.header_id
                        AND dsc.salesperson_id = jrs.resource_id
                        AND dsc.percent = '100'
                        AND trunc(dha.creation_date) BETWEEN trunc(jrs.start_date_active) AND trunc(jrs.end_date_active)
                        AND jrs.resource_id = party_id
                )) se_emp_no,
		/*(Select 
	      PPN.DISPLAY_NAME
	    From Per_Users PU,
		     Per_Person_Names_F PPN
		  Where 1=1
		    And PU.PERSON_ID = PPN.PERSON_ID
			And PU.END_DATE Is NULL
			And PPN.NAME_TYPE = 'GLOBAL'
			And PU.USERNAME = DHA.CREATED_BY
			And Trunc(Sysdate) Between Trunc(PPN.EFFECTIVE_START_DATE) And Trunc(PPN.EFFECTIVE_END_DATE)) SE_EMP_NAME,*/
                nvl((
                    SELECT DISTINCT
                        hp.party_name
                    FROM
                        doo_sales_credits   dsc, jtf_rs_salesreps    jrs, hz_parties          hp
                    WHERE
                        1 = 1
                        AND dsc.salesperson_id = dfla.salesperson_id
                        AND dsc.salesperson_id = jrs.resource_id
                        AND dsc.percent = '100'
                        AND trunc(dha.creation_date) BETWEEN trunc(jrs.start_date_active) AND trunc(jrs.end_date_active)
                        AND jrs.resource_id = party_id
                ),(
                    SELECT DISTINCT
                        hp.party_name
                    FROM
                        doo_sales_credits   dsc, jtf_rs_salesreps    jrs, hz_parties          hp
                    WHERE
                        1 = 1
                        AND dsc.header_id = dha.header_id
                        AND dsc.salesperson_id = jrs.resource_id
                        AND dsc.percent = '100'
                        AND trunc(dha.creation_date) BETWEEN trunc(jrs.start_date_active) AND trunc(jrs.end_date_active)
                        AND jrs.resource_id = party_id
                )) se_emp_name,
                dla.line_number                   so_line_no,
                (
                    SELECT
                        so_line_type.meaning
                    FROM
                        fnd_lookup_values_vl so_line_type
                    WHERE
                        so_line_type.lookup_type = 'ORA_DOO_LINE_TYPES'
                        AND so_line_type.enabled_flag = 'Y'
                        AND so_line_type.lookup_code = dla.line_type_code
                ) so_line_type,
                esi.item_number                   item_code,
                nvl(esi.description, esi.long_description) item_desc,
                ecv.category_code,
                ecv.description                   category_desc,
                iuom.unit_of_measure,
                dla.ordered_qty,
                dha.transactional_currency_code   so_currency_code,
                dla.unit_selling_price            so_line_unit_price,
                dla.extended_amount               so_line_amt,
                nvl(dha.conversion_rate,(
                    SELECT
                        gdr.conversion_rate
                    FROM
                        gl_daily_rates gdr
                    WHERE
                        1 = 1
                        AND gdr.from_currency = dha.transactional_currency_code
                        AND gdr.to_currency = 'AED'
                        AND trunc(gdr.conversion_date) = trunc(dha.creation_date)
                        AND gdr.conversion_type = dha.conversion_type_code
                )) so_exch_rate,
                (
                    SELECT
                        SUM(nvl(dot.total_amount, 0))
                    FROM
                        doo_order_totals dot
                    WHERE
                        dot.total_code IN (
                            'QP_TOTAL_NET_PRICE',
                            'QP_TOTAL_TAX'
                        )
                        AND dot.header_id = dha.header_id
                ) so_tot_amt,
                dfla.shipped_qty                  dispatch_qty,
                (
                    SELECT
                        SUM(nvl(dla1.ordered_qty, 0)) qty
                    FROM
                        doo_document_references   ddr1,
                        doo_lines_all             dla1
                    WHERE
                        ddr1.doc_ref_type = 'ORIGINAL_SALES_ORDER'
                        AND ddr1.doc_id = dla.header_id
                        AND ddr1.doc_line_id = dla.line_id
                        AND ddr1.header_id = dla1.header_id
                        AND ddr1.line_id = dla1.line_id
                        AND dla1.line_type_code = 'ORA_RETURN'
                ) return_qty,
                (
                    SELECT
                        SUM(nvl(rctl.quantity_invoiced, 0)) billed_qty
                    FROM
                        ra_customer_trx_lines_all   rctl,
                        doo_fulfill_line_details    dfld
                    WHERE
                        rctl.customer_trx_line_id = dfld.customer_trx_line_id
                        AND dfld.fulfill_line_id = dfla.fulfill_line_id
                        AND dfld.task_type = 'Invoice'
                        AND dfld.status = 'BILLED'
                ) billed_qty,
                ( dla.ordered_qty - dfla.shipped_qty ) remain_qty,
		/*(Select SO_S.MEANING 
		 From FND_LOOKUP_VALUES_VL SO_S
		   Where SO_S.LOOKUP_TYPE = 'ORA_ZCA_SO_STATUS'--'ORDER_LINE_STATUS'
			 And SO_S.ENABLED_FLAG = 'Y'
			 --And SO_S.LOOKUP_CODE = DLA.STATUS_CODE
			 And SO_S.LOOKUP_CODE = DFLA.STATUS_CODE)*/
                dla.status_code                   so_line_status,
                dfla.freight_terms_code           delivery_terms,
                dha.header_id                     so_header_id,
                dla.line_id                       so_line_id,
                dfla.fulfill_line_id,
		--DHE.ATTRIBUTE_CHAR1 SO_JOB_REF_NO,
                (
                    SELECT
                        dfld.delivery_name
                    FROM
                        doo_fulfill_line_details dfld
                    WHERE
                        dfld.fulfill_line_id = dfla.fulfill_line_id
                        AND dfld.task_type = 'Shipment'
                        AND dfld.status = 'SHIPPED'
                ) deliv_ord_num,
                dfla.fulfillment_date             deliv_date,
                (
                    SELECT
                        ppn.display_name
                    FROM
                        doo_fulfill_line_details   dfld,
                        per_users                  pu,
                        per_person_names_f         ppn
                    WHERE
                        dfld.fulfill_line_id = dfla.fulfill_line_id
                        AND dfld.task_type = 'Shipment'
                        AND dfld.status = 'SHIPPED'
                        AND dfld.created_by = pu.username
                        AND pu.person_id = ppn.person_id
                        AND pu.end_date IS NULL
                        AND ppn.name_type = 'GLOBAL'
                        AND trunc(SYSDATE) BETWEEN trunc(ppn.effective_start_date) AND trunc(ppn.effective_end_date)
                ) deliv_prp_name,
                nvl((
                    SELECT 
					 --Count(TO_NUMBER(DHI.TRANSACTION_ENTITY_ID1)) Cnt  
                        DECODE(dhi.active_flag, 'Y', 'Yes', 'No') flg
					 --MAX(DHI.TRANSACTION_ENTITY_ID1) TRANSACTION_ENTITY_ID1
                    FROM
                        doo_hold_instances dhi
                    WHERE
                        1 = 1
                        AND dhi.transaction_entity_id1 = dfla.fulfill_line_id
                        AND dhi.transaction_entity_name1 = 'DOO_ORDER_FLINES_V'
                        AND dhi.apply_system = 'DOO'
                        AND dhi.apply_date =(
                            SELECT
                                MAX(dhi1.apply_date)
                            FROM
                                doo_hold_instances dhi1
                            WHERE
                                1 = 1
                                AND dhi1.transaction_entity_id1 = dfla.fulfill_line_id
                                AND dhi1.transaction_entity_name1 = 'DOO_ORDER_FLINES_V'
                                AND dhi1.apply_system = 'DOO'
                        ) 
					--And DHI.RELEASE_USER_ID Is Null				
                ), 'No') ord_hold_flg,
                (
                    SELECT
                        trunc(dhi.apply_date) apply_date
                    FROM
                        doo_hold_instances dhi
                    WHERE
                        1 = 1
                        AND dhi.transaction_entity_id1 = dfla.fulfill_line_id
                        AND dhi.transaction_entity_name1 = 'DOO_ORDER_FLINES_V'
                        AND dhi.apply_system = 'DOO'
			--And DHI.RELEASE_USER_ID Is Null
                        AND dhi.apply_date = (
                            SELECT
                                MAX(dhi1.apply_date)
                            FROM
                                doo_hold_instances dhi1
                            WHERE
                                1 = 1
                                AND dhi1.transaction_entity_id1 = dfla.fulfill_line_id
                                AND dhi1.transaction_entity_name1 = 'DOO_ORDER_FLINES_V'
                                AND dhi1.apply_system = 'DOO'
                        )
                ) ord_hold_date,
                (
                    SELECT
                        dhi.hold_comments
                    FROM
                        doo_hold_instances dhi
                    WHERE
                        1 = 1
                        AND dhi.transaction_entity_id1 = dfla.fulfill_line_id
                        AND dhi.transaction_entity_name1 = 'DOO_ORDER_FLINES_V'
                        AND dhi.apply_system = 'DOO'
			--And DHI.RELEASE_USER_ID Is Null
                        AND dhi.apply_date = (
                            SELECT
                                MAX(dhi1.apply_date)
                            FROM
                                doo_hold_instances dhi1
                            WHERE
                                1 = 1
                                AND dhi1.transaction_entity_id1 = dfla.fulfill_line_id
                                AND dhi1.transaction_entity_name1 = 'DOO_ORDER_FLINES_V'
                                AND dhi1.apply_system = 'DOO'
                        )
                ) ord_hold_comments,
                (
                    SELECT
                        flv.meaning hold_reason
                    FROM
                        doo_hold_instances     dhi,
			  --DOO_HOLD_CODES_VL DHC
                        fnd_lookup_values_vl   flv
                    WHERE
                        1 = 1
			--And DHI.HOLD_RELEASE_REASON_CODE = DHC.HOLD_CODE
                        AND flv.lookup_type = 'DOO_HLD_RELEASE_REASON'
                        AND dhi.hold_release_reason_code = flv.lookup_code
                        AND flv.enabled_flag = 'Y'
                        AND dhi.transaction_entity_id1 = dfla.fulfill_line_id
                        AND dhi.transaction_entity_name1 = 'DOO_ORDER_FLINES_V'
                        AND dhi.apply_system = 'DOO'
                        AND dhi.release_date = (
                            SELECT
                                MAX(dhi1.release_date)
                            FROM
                                doo_hold_instances dhi1
                            WHERE
                                1 = 1
                                AND dhi1.transaction_entity_id1 = dfla.fulfill_line_id
                                AND dhi1.transaction_entity_name1 = 'DOO_ORDER_FLINES_V'
                                AND dhi1.apply_system = 'DOO'
                        )
			--And DHI.RELEASE_USER_ID Is Null	
                ) ord_rel_reason,
                (
                    SELECT
                        trunc(dhi.release_date) release_date
                    FROM
                        doo_hold_instances dhi
                    WHERE
                        1 = 1
                        AND dhi.transaction_entity_id1 = dfla.fulfill_line_id
                        AND dhi.transaction_entity_name1 = 'DOO_ORDER_FLINES_V'
                        AND dhi.apply_system = 'DOO'
			--And DHI.RELEASE_USER_ID Is Null			
                        AND dhi.release_date = (
                            SELECT
                                MAX(dhi1.release_date)
                            FROM
                                doo_hold_instances dhi1
                            WHERE
                                1 = 1
                                AND dhi1.transaction_entity_id1 = dfla.fulfill_line_id
                                AND dhi1.transaction_entity_name1 = 'DOO_ORDER_FLINES_V'
                                AND dhi1.apply_system = 'DOO'
                        )
                ) ord_hold_rel_date,
                (
                    SELECT
                        ppn.display_name display_name
                    FROM
                        doo_hold_instances     dhi,
                        per_users              pu,
                        per_person_names_f_v   ppn
                    WHERE
                        1 = 1
                        AND dhi.transaction_entity_id1 = dfla.fulfill_line_id
                        AND dhi.transaction_entity_name1 = 'DOO_ORDER_FLINES_V'
                        AND dhi.apply_system = 'DOO'
			--And DHI.RELEASE_USER_ID Is Null
                        AND dhi.release_user_id = pu.user_guid
                        AND pu.person_id = ppn.person_id
                        AND dhi.release_date = (
                            SELECT
                                MAX(dhi1.release_date)
                            FROM
                                doo_hold_instances dhi1
                            WHERE
                                1 = 1
                                AND dhi1.transaction_entity_id1 = dfla.fulfill_line_id
                                AND dhi1.transaction_entity_name1 = 'DOO_ORDER_FLINES_V'
                                AND dhi1.apply_system = 'DOO'
                        )
                ) ord_hold_rel_by
            FROM
                doo_headers_all           dha,
                doo_headers_eff_b         dhe,
                doo_lines_all             dla,
                bu_v,
                doo_fulfill_lines_all     dfla,
                fnd_lookup_values_vl      so_flv,
                egp_system_items          esi,
                egp_item_categories       eic,
                egp_categories_vl         ecv,
                inv_units_of_measure_vl   iuom
            WHERE
                1 = 1
                AND dha.header_id = dla.header_id
                AND dha.header_id = dhe.header_id (+)
                AND dhe.context_code (+) = 'AS SO Additional Information'
                AND dha.org_id = bu_v.bu_id
                AND dha.header_id = dfla.header_id
                AND dla.line_id = dfla.line_id
                AND so_flv.lookup_type = 'ORA_DOO_ORDER_TYPES'
                AND dha.order_type_code = so_flv.lookup_code
                AND so_flv.enabled_flag = 'Y'
                AND dla.inventory_item_id = esi.inventory_item_id
                AND dla.inventory_organization_id = esi.organization_id
                AND esi.inventory_item_id = eic.inventory_item_id
                AND esi.organization_id = eic.organization_id
                AND eic.category_id = ecv.category_id
                AND esi.primary_uom_code = iuom.uom_code
                AND ( dha.order_number IN (
                    :p_so_no
                )
                      OR least(:p_so_no) IS NULL )
                AND ecv.category_code BETWEEN nvl(:p_from_cat, ecv.category_code) AND nvl(:p_to_cat, ecv.category_code)
  --And Trunc(DHA.CREATION_DATE) Between Nvl(:P_FROM_SO_DT,Trunc(DHA.CREATION_DATE)) And Nvl(:P_TO_SO_DT,Trunc(DHA.CREATION_DATE))
  --And (To_Date(Trunc(DHA.CREATION_DATE),'yyyy-MM-dd') Between Nvl(:P_FROM_SO_DT,To_Date(Trunc(DHA.CREATION_DATE),'yyyy-MM-dd')) And Nvl(:P_TO_SO_DT,To_Date(Trunc(DHA.CREATION_DATE),'yyyy-MM-dd')))
                AND ( TO_CHAR(trunc(dha.creation_date), 'yyyy-MM-dd') BETWEEN nvl(:p_from_so_dt, TO_CHAR(trunc(dha.creation_date)
                , 'yyyy-MM-dd')) AND nvl(:p_to_so_dt, TO_CHAR(trunc(dha.creation_date), 'yyyy-MM-dd')) )
  --And Trunc(DFLA.FULFILLMENT_DATE) Between Nvl(:P_FROM_DEL_DT,Trunc(DFLA.FULFILLMENT_DATE)) And Nvl(:P_TO_DEL_DT,Trunc(DFLA.FULFILLMENT_DATE))
  --And (To_Date(Trunc(DFLA.FULFILLMENT_DATE),'yyyy-MM-dd') Between Nvl(:P_FROM_DEL_DT,To_Date(Trunc(DFLA.FULFILLMENT_DATE),'yyyy-MM-dd')) And Nvl(:P_TO_DEL_DT,To_Date(Trunc(DFLA.FULFILLMENT_DATE),'yyyy-MM-dd')))
  --And (To_Date(Trunc(Nvl(DFLA.FULFILLMENT_DATE,SYSDATE)),'yyyy-MM-dd') Between Nvl(:P_FROM_DEL_DT,To_Date(Trunc(Nvl(DFLA.FULFILLMENT_DATE,SYSDATE)),'yyyy-MM-dd')) And Nvl(:P_TO_DEL_DT,To_Date(Trunc(Nvl(DFLA.FULFILLMENT_DATE,SYSDATE)),'yyyy-MM-dd')))
                AND ( TO_CHAR(trunc(nvl(dfla.fulfillment_date, SYSDATE)), 'yyyy-MM-dd') BETWEEN nvl(:p_from_del_dt, TO_CHAR(trunc
                (nvl(dfla.fulfillment_date, SYSDATE)), 'yyyy-MM-dd')) AND nvl(:p_to_del_dt, TO_CHAR(trunc(nvl(dfla.fulfillment_date
                , SYSDATE)), 'yyyy-MM-dd')) )
        ), po_v AS (
            SELECT
                ddr.header_id         d_header_id,
                ddr.line_id           d_line_id,
                ddr.fulfill_line_id   d_fulfill_line_id,
                ddr.doc_id            po_header_id,
                ddr.doc_user_key      po_num,
                pss.segment1          vendor_num,
                pss.vendor_name,
                pss.attribute1        icv_value
            FROM
                doo_document_references   ddr,
                po_headers_all            pha,
                poz_suppliers_v           pss
            WHERE
                ddr.doc_ref_type = 'DROPSHIP_PO_REFERENCE'
                AND ddr.doc_id = pha.po_header_id
                AND ddr.doc_user_key = pha.segment1
                AND pha.vendor_id = pss.vendor_id
        ), ar_inv_v AS (
            SELECT
                ar_inv.customer_trx_id,
                ar_inv.invoice_type,
                ar_inv.inv_num,
                ar_inv.i_so_no,
                ar_inv.inv_date,
                ar_inv.inv_doc_seq_val,
                ar_inv.inv_e_curr,
                ar_inv.tax_rate_code,
                ar_inv.tax_rate,
                ar_inv.i_exch_rate,
                ar_inv.inv_terms,
                ar_inv.inv_term_desc,
                ar_inv.inv_cre_by,
                SUM(nvl(ar_inv.sales_amt, 0)) sales_amt,
                SUM(nvl(ar_inv.tax_amt, 0)) tax_amt,
                SUM(nvl(ar_inv.sales_amount_aed, 0)) sales_amount_aed,
                SUM(nvl(ar_inv.tax_amt_aed, 0)) tax_amt_aed,
                SUM(nvl(ar_inv.sales_tot_amt, 0)) sales_tot_amt,
                SUM(nvl(ar_inv.sales_tot_amt_aed, 0)) sales_tot_amt_aed
            FROM
                (
                    SELECT
                        rct.customer_trx_id,
                        rctl.customer_trx_line_id,
                        rctt.name                         invoice_type,
                        rct.trx_number                    inv_num,
                        rct.interface_header_attribute3   i_so_no,
                        rct.trx_date                      inv_date,
                        rct.doc_sequence_value            inv_doc_seq_val,
                        rct.invoice_currency_code         inv_e_curr,
                        nvl(rctl.extended_amount, 0) sales_amt,
                        nvl(zx_tax.tax_amt, 0) tax_amt,
                        zx_tax.tax_rate_code              tax_rate_code,
                        zx_tax.tax_rate || '%' tax_rate,
                        rct.exchange_rate                 i_exch_rate,
                        nvl(rct.exchange_rate, 1) * nvl(rctl.extended_amount, 0) sales_amount_aed,
                        nvl(rct.exchange_rate, 1) * nvl(zx_tax.tax_amt, 0) tax_amt_aed,
                        ( nvl(rctl.extended_amount, 0) + nvl(zx_tax.tax_amt, 0) ) sales_tot_amt,
                        ( nvl(rct.exchange_rate, 1) * nvl(rctl.extended_amount, 0) + nvl(rct.exchange_rate, 1) * nvl(zx_tax.tax_amt
                        , 0) ) sales_tot_amt_aed,
                        rtv.name                          inv_terms,
                        rtv.description                   inv_term_desc,
                        (
                            SELECT
                                ppn.display_name
                            FROM
                                per_users            pu,
                                per_person_names_f   ppn
                            WHERE
                                1 = 1
                                AND pu.person_id = ppn.person_id
                                AND pu.end_date IS NULL
                                AND ppn.name_type = 'GLOBAL'
                                AND pu.username = rct.created_by
                                AND trunc(SYSDATE) BETWEEN trunc(ppn.effective_start_date) AND trunc(ppn.effective_end_date)
                        ) inv_cre_by
                    FROM
                        ra_customer_trx_all         rct,
                        ra_cust_trx_types_all       rctt,
                        ra_customer_trx_lines_all   rctl,
                        (
                            SELECT
                                nvl(SUM(zl.tax_amt), 0) tax_amt,
                                zl.trx_line_id,
                                zl.tax_rate,
                                zl.tax_rate_code,
                                zl.trx_id
                            FROM
                                zx_lines     zl,
                                zx_taxes_b   zb
                            WHERE
                                zl.tax = zb.tax
                                AND zb.allow_recoverability_flag = 'Y'
                            GROUP BY
                                zl.trx_line_id,
                                zl.tax_rate,
                                zl.tax_rate_code,
                                zl.trx_id
                        ) zx_tax,
                        ra_terms_vl                 rtv
                    WHERE
                        1 = 1
                        AND rct.cust_trx_type_seq_id = rctt.cust_trx_type_seq_id
                        AND rct.customer_trx_id = rctl.customer_trx_id
                        AND rctl.line_type = 'LINE'
                        AND rct.customer_trx_id = zx_tax.trx_id (+)
                        AND rctl.customer_trx_line_id = zx_tax.trx_line_id (+)
                        AND rct.term_id = rtv.term_id
                ) ar_inv,
                so_v
            WHERE
                ar_inv.i_so_no = so_v.so_no
            GROUP BY
                ar_inv.customer_trx_id,
                ar_inv.invoice_type,
                ar_inv.inv_num,
                ar_inv.i_so_no,
                ar_inv.inv_date,
                ar_inv.inv_doc_seq_val,
                ar_inv.inv_e_curr,
                ar_inv.tax_rate_code,
                ar_inv.tax_rate,
                ar_inv.i_exch_rate,
                ar_inv.inv_terms,
                ar_inv.inv_term_desc,
                ar_inv.inv_cre_by
        ), csh_rcpt_v AS (
            SELECT
                acra.receipt_date,
                (
                    SELECT
                        flv.meaning
                    FROM
                        fnd_lookup_values_vl flv
                    WHERE
                        flv.lookup_type = 'TRANSACTION TYPE'
                        AND flv.enabled_flag = 'Y'
                        AND flv.lookup_code = acra.type
                ) receipt_type,
                acra.receipt_number,
                acra.doc_sequence_value        r_vch_no,
                acra.currency_code             r_currency_code,
                nvl(acra.amount, 0) r_amt,
                acra.exchange_rate             r_exch_rate,
                ( nvl(acra.amount, 0) * nvl(acra.exchange_rate, 1) ) r_amt_aed,
  --ARPS.CUSTOMER_TRX_ID
                araa.applied_customer_trx_id   customer_trx_id
            FROM
                ar_cash_receipts_all             acra,
                ar_payment_schedules_all         arps,
                ar_receivable_applications_all   araa,
                ar_inv_v
            WHERE
                acra.cash_receipt_id = arps.cash_receipt_id
  --And ARPS.CUSTOMER_TRX_ID = AR_INV_V.CUSTOMER_TRX_ID
                AND acra.cash_receipt_id = araa.cash_receipt_id
                AND arps.payment_schedule_id = araa.payment_schedule_id
                AND araa.status = 'APP'
                AND araa.applied_customer_trx_id = ar_inv_v.customer_trx_id
        )
/*=================================ONLY LEAD =======================================*/
        SELECT 
  --ROWNUM SR_NO,
            bu_v.bu_name,
            lead_opp_v.division,
            cust_dtl_v.account_number,
            cust_dtl_v.party_name,
            cust_dtl_v.contact_name,
            cust_dtl_v.contact_mail,
            cust_dtl_v.contact_phone,
            cust_dtl_v.cust_reg_number,
  --LEAD_OPP_V.L_SALES_ENGINEER,
            NULL l_sales_engineer,
            lead_opp_v.lead_number,
            lead_opp_v.lead_name,
            lead_opp_v.l_preparer,
            trunc(lead_opp_v.lead_creation_date) lead_creation_date,
            trunc(lead_opp_v.l_apprd_dt) l_apprd_dt,
            lead_opp_v.l_appr_sts,
            lead_opp_v.opty_number,
            trunc(lead_opp_v.opty_creation_date) opty_creation_date,
            lead_opp_v.appd_qut_no,
            trunc(lead_opp_v.appd_qut_dt) appd_qut_dt,
            lead_opp_v.l_job_ref_no,
            lead_opp_v.profit_center,
            NULL so_agr_no,
            NULL so_agr_lin_no,
            NULL so_no,
            NULL so_cre_dt,
            NULL so_rel_dt,
            NULL so_ord_typ,
            NULL so_status,
            NULL se_emp_no,
            NULL se_emp_name,
            NULL so_line_no,
            NULL so_line_type,
            NULL category_code,
            NULL category_desc,
            NULL item_code,
            NULL item_desc,
            NULL unit_of_measure,
            NULL ordered_qty,
            NULL so_currency_code,
            NULL so_line_unit_price,
            NULL so_line_amt,
            NULL so_exch_rate,
            NULL so_tot_amt,
            NULL dispatch_qty,
            NULL d_dispatch_qty,
            NULL return_qty,
            NULL so_remain_qty,
            NULL billed_qty,
            NULL so_line_status,
            NULL delivery_terms,
            NULL deliv_ord_num,
            NULL deliv_date,
            NULL deliv_prp_name,
            NULL po_num,
            NULL vendor_num,
            NULL vendor_name,
            NULL icv_value,
            NULL icv_value_aed,
            NULL invoice_type,
            NULL inv_num,
            NULL inv_date,
            NULL inv_doc_seq_val,
            NULL inv_e_curr,
            NULL sales_amt,
            NULL tax_rate_code,
            NULL tax_amt,
            NULL sales_tot_amt,
            NULL i_exch_rate,
            NULL sales_amount_aed,
            NULL tax_amt_aed,
            NULL sales_tot_amt_aed,
            NULL inv_terms,
            NULL inv_term_desc,
            NULL inv_cre_by,
            NULL receipt_date,
            NULL receipt_type,
            NULL receipt_number,
            NULL r_vch_no,
            NULL r_currency_code,
            NULL r_amt,
            NULL r_exch_rate,
            NULL r_amt_aed,
            NULL ord_hold_flg,
            NULL ord_hold_date,
            NULL ord_hold_comments,
            NULL ord_rel_reason,
            NULL ord_hold_rel_date,
            NULL ord_hold_rel_by,
            NULL fulfill_line_id
        FROM
            bu_v,
            lead_opp_v,
            cust_dtl_v/*,
	 SO_V,
	 PO_V,
	 AR_INV_V,
	 CSH_RCPT_V*/
        WHERE
            1 = 1
            AND bu_v.bu_id = lead_opp_v.l_bu_id
            AND lead_opp_v.l_party_id = cust_dtl_v.party_id
	/*And LEAD_OPP_V.L_JOB_REF_NO = SO_V.SO_JOB_REF_NO(+)
	And (SO_V.SO_AGR_NO In (:P_SO_AGR_NO) Or Least (:P_SO_AGR_NO) Is Null)
	And SO_V.SO_HEADER_ID = PO_V.D_HEADER_ID (+)
	And SO_V.SO_LINE_ID = PO_V.D_LINE_ID (+)
	And SO_V.FULFILL_LINE_ID = PO_V.D_FULFILL_LINE_ID (+)
	And SO_V.SO_NO = AR_INV_V.I_SO_NO (+)
	And AR_INV_V.CUSTOMER_TRX_ID = CSH_RCPT_V.CUSTOMER_TRX_ID (+)
	And (SO_V.SO_STATUS In (:P_SO_STATUS) Or Least (:P_SO_STATUS) Is Null)
	And (SO_V.SE_EMP_NAME In (:P_L_SE) Or Least (:P_L_SE) Is Null)*/
            AND ( lead_opp_v.division IN (
                :p_div
            )
                  OR least(:p_div) IS NULL )
            AND ( lead_opp_v.lead_number IN (
                :p_lead_no
            )
                  OR least(:p_lead_no) IS NULL )
            AND ( lead_opp_v.opty_number IN (
                :p_opty_no
            )
                  OR least(:p_opty_no) IS NULL )
            AND ( lead_opp_v.appd_qut_no IN (
                :p_quote_no
            )
                  OR least(:p_quote_no) IS NULL )
            AND ( lead_opp_v.l_job_ref_no IN (
                :p_l_job_ref_no
            )
                  OR least(:p_l_job_ref_no) IS NULL )
            AND NOT EXISTS (
                SELECT DISTINCT
                    1
                FROM
                    so_v
                WHERE
                    so_v.so_job_ref_no = lead_opp_v.l_job_ref_no
            )
/*=================================LEAD WITH SO =======================================*/
        UNION
        SELECT 
  --ROWNUM SR_NO,
            bu_v.bu_name,
            lead_opp_v.division,
            cust_dtl_v.account_number,
            cust_dtl_v.party_name,
            cust_dtl_v.contact_name,
            cust_dtl_v.contact_mail,
            cust_dtl_v.contact_phone,
            cust_dtl_v.cust_reg_number,
  --LEAD_OPP_V.L_SALES_ENGINEER,
            so_v.se_emp_name    l_sales_engineer,
            lead_opp_v.lead_number,
            lead_opp_v.lead_name,
            lead_opp_v.l_preparer,
            trunc(lead_opp_v.lead_creation_date) lead_creation_date,
            trunc(lead_opp_v.l_apprd_dt) l_apprd_dt,
            lead_opp_v.l_appr_sts,
            lead_opp_v.opty_number,
            trunc(lead_opp_v.opty_creation_date) opty_creation_date,
            lead_opp_v.appd_qut_no,
            trunc(lead_opp_v.appd_qut_dt) appd_qut_dt,
            lead_opp_v.l_job_ref_no,
            lead_opp_v.profit_center,
            so_v.so_agr_no,
            so_v.so_agr_lin_no,
            so_v.so_no,
            trunc(so_v.so_cre_dt) so_cre_dt,
            trunc(so_v.so_rel_dt) so_rel_dt,
            so_v.so_ord_typ,
            so_v.so_status,
            so_v.se_emp_no,
            so_v.se_emp_name,
            so_v.so_line_no,
            so_v.so_line_type,
            so_v.category_code,
            so_v.category_desc,
            so_v.item_code,
            so_v.item_desc,
            so_v.unit_of_measure,
            so_v.ordered_qty,
            so_v.so_currency_code,
            so_v.so_line_unit_price,
            so_v.so_line_amt,
            so_v.so_exch_rate,
            (
                CASE
                    WHEN so_v.so_currency_code = 'AED' THEN
                        so_v.so_tot_amt
                    ELSE
                        ( so_v.so_tot_amt * so_v.so_exch_rate )
                END
            ) so_tot_amt,
            so_v.dispatch_qty,
            so_v.dispatch_qty   d_dispatch_qty,
            so_v.return_qty,
            ( so_v.remain_qty + so_v.return_qty ) so_remain_qty,
            so_v.billed_qty,
            so_v.so_line_status,
            so_v.delivery_terms,
            so_v.deliv_ord_num,
            trunc(so_v.deliv_date) deliv_date,
            so_v.deliv_prp_name,
            po_v.po_num,
            po_v.vendor_num,
            po_v.vendor_name,
            po_v.icv_value,
            ( po_v.icv_value * nvl(ar_inv_v.i_exch_rate, 1) ) icv_value_aed,
            ar_inv_v.invoice_type,
            ar_inv_v.inv_num,
            trunc(ar_inv_v.inv_date) inv_date,
            ar_inv_v.inv_doc_seq_val,
            ar_inv_v.inv_e_curr,
            ar_inv_v.sales_amt,
            ar_inv_v.tax_rate_code,
            ar_inv_v.tax_amt,
            ar_inv_v.sales_tot_amt,
            ar_inv_v.i_exch_rate,
            ar_inv_v.sales_amount_aed,
            ar_inv_v.tax_amt_aed,
            ar_inv_v.sales_tot_amt_aed,
            ar_inv_v.inv_terms,
            ar_inv_v.inv_term_desc,
            ar_inv_v.inv_cre_by,
            trunc(csh_rcpt_v.receipt_date) receipt_date,
            csh_rcpt_v.receipt_type,
            csh_rcpt_v.receipt_number,
            csh_rcpt_v.r_vch_no,
            csh_rcpt_v.r_currency_code,
            csh_rcpt_v.r_amt,
            csh_rcpt_v.r_exch_rate,
            csh_rcpt_v.r_amt_aed,
            so_v.ord_hold_flg,
            so_v.ord_hold_date,
            so_v.ord_hold_comments,
            so_v.ord_rel_reason,
            so_v.ord_hold_rel_date,
            so_v.ord_hold_rel_by,
            so_v.fulfill_line_id
        FROM
            bu_v,
            lead_opp_v,
            cust_dtl_v,
            so_v,
            po_v,
            ar_inv_v,
            csh_rcpt_v
        WHERE
            1 = 1
            AND bu_v.bu_id = lead_opp_v.l_bu_id
            AND lead_opp_v.l_party_id = cust_dtl_v.party_id
            AND lead_opp_v.l_job_ref_no = so_v.so_job_ref_no
            AND lead_opp_v.lead_number = so_v.so_lead_no
            AND lead_opp_v.opty_number = so_v.so_opty_no
            AND lead_opp_v.appd_qut_no = so_v.so_quote_no
            AND ( so_v.so_no IN (
                :p_so_no
            )
                  OR least(:p_so_no) IS NULL )
            AND ( so_v.so_agr_no IN (
                :p_so_agr_no
            )
                  OR least(:p_so_agr_no) IS NULL )
            AND so_v.so_header_id = po_v.d_header_id (+)
            AND so_v.so_line_id = po_v.d_line_id (+)
            AND so_v.fulfill_line_id = po_v.d_fulfill_line_id (+)
            AND so_v.so_no = ar_inv_v.i_so_no (+)
            AND ar_inv_v.customer_trx_id = csh_rcpt_v.customer_trx_id (+)
            AND ( so_v.so_status IN (
                :p_so_status
            )
                  OR least(:p_so_status) IS NULL )
            AND ( so_v.se_emp_name IN (
                :p_l_se
            )
                  OR least(:p_l_se) IS NULL )
/*=================================ONLY SO =======================================*/
        UNION
        SELECT 
  --ROWNUM SR_NO,
            bu_v.bu_name,
            NULL division,
            cust_dtl_v.account_number,
            cust_dtl_v.party_name,
            cust_dtl_v.contact_name,
            cust_dtl_v.contact_mail,
            cust_dtl_v.contact_phone,
            cust_dtl_v.cust_reg_number,
  --LEAD_OPP_V.L_SALES_ENGINEER,
            so_v.se_emp_name     l_sales_engineer,
            NULL lead_number,
            NULL lead_name,
            NULL l_preparer,
            NULL lead_creation_date,
            NULL l_apprd_dt,
            NULL l_appr_sts,
            NULL opty_number,
            NULL opty_creation_date,
            NULL appd_qut_no,
            NULL appd_qut_dt,
            so_v.so_job_ref_no   l_job_ref_no,
            NULL profit_center,
            so_v.so_agr_no,
            so_v.so_agr_lin_no,
            so_v.so_no,
            trunc(so_v.so_cre_dt) so_cre_dt,
            trunc(so_v.so_rel_dt) so_rel_dt,
            so_v.so_ord_typ,
            so_v.so_status,
            so_v.se_emp_no,
            so_v.se_emp_name,
            so_v.so_line_no,
            so_v.so_line_type,
            so_v.category_code,
            so_v.category_desc,
            so_v.item_code,
            so_v.item_desc,
            so_v.unit_of_measure,
            so_v.ordered_qty,
            so_v.so_currency_code,
            so_v.so_line_unit_price,
            so_v.so_line_amt,
            so_v.so_exch_rate,
            so_v.so_tot_amt,
            so_v.dispatch_qty,
            so_v.dispatch_qty    d_dispatch_qty,
            so_v.return_qty,
            ( so_v.remain_qty + so_v.return_qty ) so_remain_qty,
            so_v.billed_qty,
            so_v.so_line_status,
            so_v.delivery_terms,
            so_v.deliv_ord_num,
            trunc(so_v.deliv_date) deliv_date,
            so_v.deliv_prp_name,
            po_v.po_num,
            po_v.vendor_num,
            po_v.vendor_name,
            po_v.icv_value,
            ( po_v.icv_value * nvl(ar_inv_v.i_exch_rate, 1) ) icv_value_aed,
            ar_inv_v.invoice_type,
            ar_inv_v.inv_num,
            trunc(ar_inv_v.inv_date) inv_date,
            ar_inv_v.inv_doc_seq_val,
            ar_inv_v.inv_e_curr,
            ar_inv_v.sales_amt,
            ar_inv_v.tax_rate_code,
            ar_inv_v.tax_amt,
            ar_inv_v.sales_tot_amt,
            ar_inv_v.i_exch_rate,
            ar_inv_v.sales_amount_aed,
            ar_inv_v.tax_amt_aed,
            ar_inv_v.sales_tot_amt_aed,
            ar_inv_v.inv_terms,
            ar_inv_v.inv_term_desc,
            ar_inv_v.inv_cre_by,
            trunc(csh_rcpt_v.receipt_date) receipt_date,
            csh_rcpt_v.receipt_type,
            csh_rcpt_v.receipt_number,
            csh_rcpt_v.r_vch_no,
            csh_rcpt_v.r_currency_code,
            csh_rcpt_v.r_amt,
            csh_rcpt_v.r_exch_rate,
            csh_rcpt_v.r_amt_aed,
            so_v.ord_hold_flg,
            so_v.ord_hold_date,
            so_v.ord_hold_comments,
            so_v.ord_rel_reason,
            so_v.ord_hold_rel_date,
            so_v.ord_hold_rel_by,
            so_v.fulfill_line_id
        FROM
            bu_v,
	 --LEAD_OPP_V,
            cust_dtl_v,
            so_v,
            po_v,
            ar_inv_v,
            csh_rcpt_v
        WHERE
            1 = 1
            AND bu_v.bu_id = so_v.org_id
            AND cust_dtl_v.party_id = so_v.sold_to_party_id
            AND ( so_v.so_no IN (
                :p_so_no
            )
                  OR least(:p_so_no) IS NULL )
            AND ( so_v.so_agr_no IN (
                :p_so_agr_no
            )
                  OR least(:p_so_agr_no) IS NULL )
            AND so_v.so_header_id = po_v.d_header_id (+)
            AND so_v.so_line_id = po_v.d_line_id (+)
            AND so_v.fulfill_line_id = po_v.d_fulfill_line_id (+)
            AND so_v.so_no = ar_inv_v.i_so_no (+)
            AND ar_inv_v.customer_trx_id = csh_rcpt_v.customer_trx_id (+)
            AND ( so_v.so_status IN (
                :p_so_status
            )
                  OR least(:p_so_status) IS NULL )
            AND ( so_v.se_emp_name IN (
                :p_l_se
            )
                  OR least(:p_l_se) IS NULL )
            AND NOT EXISTS (
                SELECT DISTINCT
                    1
                FROM
                    lead_opp_v
                WHERE
                    lead_opp_v.l_job_ref_no = so_v.so_job_ref_no
            )
	--ANd SO_V.SO_NO = '191'
    ) sod
WHERE
    1 = 1
    AND ( sod.bu_name IN (
        :p_bu_name
    )
          OR least(:p_bu_name) IS NULL )
    AND ( sod.lead_number IN (
        :p_lead_no
    )
          OR least(:p_lead_no) IS NULL )
 --And SOD.LEAD_NUMBER = '149016'
    AND ( sod.opty_number IN (
        :p_opty_no
    )
          OR least(:p_opty_no) IS NULL )
    AND ( sod.appd_qut_no IN (
        :p_quote_no
    )
          OR least(:p_quote_no) IS NULL )
    AND ( sod.l_job_ref_no IN (
        :p_l_job_ref_no
    )
          OR least(:p_l_job_ref_no) IS NULL )
    AND ( sod.division IN (
        :p_div
    )
          OR least(:p_div) IS NULL )
    AND ( sod.se_emp_name IN (
        :p_l_se
    )
          OR least(:p_l_se) IS NULL )
    AND ( sod.party_name IN (
        :p_party_name
    )
          OR least(:p_party_name) IS NULL )
    AND ( sod.so_status IN (
        :p_so_status
    )
          OR least(:p_so_status) IS NULL )
    AND ( sod.so_no IN (
        :p_so_no
    )
          OR least(:p_so_no) IS NULL )
    AND ( sod.so_agr_no IN (
        :p_so_agr_no
    )
          OR least(:p_so_agr_no) IS NULL )
    AND nvl(sod.category_code, 'XXXX') BETWEEN nvl(:p_from_cat, nvl(sod.category_code, 'XXXX')) AND nvl(:p_to_cat, nvl(sod.category_code
    , 'XXXX'))
 --And (To_Date(Trunc(Nvl(SOD.SO_CRE_DT,Sysdate)),'yyyy-MM-dd') Between Nvl(:P_FROM_SO_DT,To_Date(Trunc(Nvl(SOD.SO_CRE_DT,Sysdate)),'yyyy-MM-dd')) And Nvl(:P_TO_SO_DT,To_Date(Trunc(Nvl(SOD.SO_CRE_DT,Sysdate)),'yyyy-MM-dd'))) 
    AND ( TO_CHAR(trunc(nvl(sod.so_cre_dt, SYSDATE)), 'yyyy-MM-dd') BETWEEN nvl(:p_from_so_dt, TO_CHAR(trunc(nvl(sod.so_cre_dt, SYSDATE
    )), 'yyyy-MM-dd')) AND nvl(:p_to_so_dt, TO_CHAR(trunc(nvl(sod.so_cre_dt, SYSDATE)), 'yyyy-MM-dd')) ) 
 --And (To_Date(Trunc(Nvl(SOD.DELIV_DATE,SYSDATE)),'yyyy-MM-dd') Between Nvl(:P_FROM_DEL_DT,To_Date(Trunc(Nvl(SOD.DELIV_DATE,SYSDATE)),'yyyy-MM-dd')) And Nvl(:P_TO_DEL_DT,To_Date(Trunc(Nvl(SOD.DELIV_DATE,SYSDATE)),'yyyy-MM-dd')))
    AND ( TO_CHAR(trunc(nvl(sod.deliv_date, SYSDATE)), 'yyyy-MM-dd') BETWEEN nvl(:p_from_del_dt, TO_CHAR(trunc(nvl(sod.deliv_date
    , SYSDATE)), 'yyyy-MM-dd')) AND nvl(:p_to_del_dt, TO_CHAR(trunc(nvl(sod.deliv_date, SYSDATE)), 'yyyy-MM-dd')) )
--Order by rownum asc
ORDER BY
    sod.lead_number ASC NULLS LAST,
    sod.opty_number ASC NULLS LAST,
    sod.appd_qut_no ASC NULLS LAST,
    sod.so_no ASC NULLS LAST
